<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>旅行记忆本 · 与她的旅程（Firebase 实时同步 · iPhone 优化）</title>
  <meta name="description" content="单文件旅行记录本：文字/地点/时间/照片/视频；在线地图（Leaflet）；Firebase 实时同步；搜索＋分页；iPhone Safari 适配。">

  <style>
    :root{
      --bg:#0b0d12; --card:#121722; --text:#e6ebf4; --muted:#a9b4c8;
      --brand:#3b82f6; --accent:#22d3ee; --ring:rgba(59,130,246,.35);
      --outline:rgba(255,255,255,.10); --outline-2:rgba(255,255,255,.18);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    [data-theme="light"]{
      --bg:#f6f8fc; --card:#ffffff; --text:#111827; --muted:#5b677d;
      --brand:#2563eb; --accent:#06b6d4; --ring:rgba(37,99,235,.25);
      --outline:rgba(0,0,0,.08); --outline-2:rgba(0,0,0,.12);
    }

    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      padding-bottom: var(--safe-bottom);
    }
    a{color:inherit;text-decoration:none}
    .container{width:min(1100px,90vw);margin-inline:auto}

    header{
      position:sticky;top:0;z-index:10;
      -webkit-backdrop-filter:saturate(160%) blur(10px);
      backdrop-filter:saturate(160%) blur(10px);
      background:rgba(17,23,34,.55);
      border-bottom:1px solid var(--outline);
      padding-top: calc(var(--safe-top) * 1);
    }
    [data-theme="light"] header{background:rgba(255,255,255,.7)}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:.5rem 0}
    .brand{font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:.5rem}
    .actions{display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}

    .btn{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:.55rem .9rem;border-radius:12px;border:1px solid var(--outline-2);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      color:var(--text);cursor:pointer;font-size:.95rem;-webkit-tap-highlight-color: transparent;
    }
    .btn.primary{background:linear-gradient(180deg,var(--brand),#1d4ed8);color:#fff;border:0}
    .btn:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .pill{display:inline-block;font-size:.78rem;color:var(--brand);background:rgba(59,130,246,.12);padding:.15rem .55rem;border-radius:999px;border:1px solid rgba(59,130,246,.25)}
    .section{padding:1.2rem 0 2.2rem}

    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:1rem;box-shadow:0 4px 16px rgba(0,0,0,.12)}
    .card h3{margin:.2rem 0 .6rem}

    .hero{position:relative;display:grid;grid-template-columns:1.1fr .9fr;align-items:center;gap:1.4rem;padding:1.2rem 0 .8rem}
    .hero::before{
      content:""; position:absolute; inset:-40px -100vw 40px -100vw; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(59,130,246,.25), transparent),
        radial-gradient(900px 600px at -10% 10%, rgba(34,211,238,.18), transparent);
      -webkit-mask-image:linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,0) 70%);
              mask-image:linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,0) 70%);
    }
    @media (max-width:980px){.hero{grid-template-columns:1fr}}

    input,textarea,select{
      width:100%;padding:.75rem;border-radius:12px;border:1px solid var(--outline);background:transparent;color:var(--text);
      -webkit-appearance:none;appearance:none;
    }
    label{font-size:.9rem;color:var(--muted)}
    .help{color:var(--muted);font-size:.85rem}

    .list{display:grid;gap:1rem}
    .entry{display:grid;grid-template-columns:120px 1fr;gap:1rem;align-items:center}
    .thumb{width:120px;height:80px;object-fit:cover;border-radius:12px;border:1px solid var(--outline-2);background:#00000022}
    .thumb-btn{padding:0;border:0;background:transparent;cursor:pointer;border-radius:12px}
    .thumb-btn:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
    .meta{display:flex;gap:.6rem;flex-wrap:wrap;color:var(--muted);font-size:.9rem}

    .gallery{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem}
    @media (max-width:980px){.gallery{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.gallery{grid-template-columns:repeat(2,1fr)}}
    .media{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--outline)}
    .media img,.media video{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;right:.4rem;top:.4rem;background:rgba(0,0,0,.45);color:#fff;padding:.1rem .4rem;border-radius:8px;font-size:.75rem}

    dialog{border:1px solid var(--outline);border-radius:18px;padding:0;background:var(--card);color:var(--text);width:min(980px,94vw)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--outline)}
    .modal-body{padding:1rem;max-height:min(72vh,820px);overflow:auto;-webkit-overflow-scrolling:touch}

    .dlg-open{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
    .dlg-panel{background:var(--card);border:1px solid var(--outline);border-radius:18px;width:min(980px,94vw);max-height:min(72vh,820px);display:flex;flex-direction:column}
    .dlg-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9998}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media (max-width:640px){.row{grid-template-columns:1fr}}

    footer{border-top:1px solid var(--outline);padding:2rem 0;color:var(--muted);text-align:center}

    /* 主题 & 自定义背景 */
    [data-theme="sakura"]{ --bg:#1a1325; --card:#20172d; --text:#fdeaf6; --muted:#d9c0d8; --brand:#ec4899; --accent:#fb7185; --ring:rgba(236,72,153,.30); }
    [data-theme="ocean"] { --bg:#08121a; --card:#0f1b27; --text:#e6f6ff; --muted:#a0c3d7; --brand:#06b6d4; --accent:#22d3ee; --ring:rgba(6,182,212,.30); }
    [data-theme="forest"]{ --bg:#0b130f; --card:#111c16; --text:#e9faef; --muted:#b2d3bc; --brand:#22c55e; --accent:#16a34a; --ring:rgba(34,197,94,.30); }
    [data-theme="warm"]  { --bg:#18110b; --card:#1f1710; --text:#fff4e5; --muted:#e6d1bb; --brand:#f59e0b; --accent:#f97316; --ring:rgba(245,158,11,.30); }
    #userBg{position:fixed; inset:0; background:var(--user-bg, none); background-size:cover; background-position:center; background-repeat:no-repeat; opacity:var(--user-bg-opacity, .22); pointer-events:none; z-index:-1}

    [contenteditable="true"]{outline:2px dashed transparent;border-radius:10px;transition:.2s}
    [contenteditable="true"]:hover{outline-color:rgba(255,255,255,.12)}
    [data-theme="light"] [contenteditable="true"]:hover{outline-color:rgba(0,0,0,.1)}
    [contenteditable="true"]:focus{outline-color:var(--accent);background-color:rgba(255,255,255,.03)}
    [data-theme="light"] [contenteditable="true"]:focus{background-color:rgba(0,0,0,.03)}

    /* 地图 */
    #mapWrap{margin-top:.6rem}
    #map{height:420px;border-radius:16px;border:1px solid var(--outline);overflow:hidden}
    .leaflet-container{font:inherit; touch-action: pan-x pan-y;}
    .map-tools{display:flex;gap:.5rem;flex-wrap:wrap}
    .map-note{font-size:.85rem;color:var(--muted)}

    /* 搜索栏 */
    .searchbar{display:flex;gap:.5rem;align-items:center;margin:.2rem 0 1rem}

    /* 小图标按钮（旅行语录） */
    .icon-btn{
      width:38px;height:38px;border-radius:999px;border:1px solid var(--outline-2);
      display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      cursor:pointer;-webkit-tap-highlight-color:transparent;
    }
    .icon-btn[aria-pressed="true"]{outline:3px solid var(--ring);outline-offset:2px}
    .icon{width:18px;height:18px;display:block}

    /* 分页 */
    .pager{display:flex;gap:.5rem;align-items:center;justify-content:center;margin-top:1rem}
    .pager .info{min-width:7ch;text-align:center;color:var(--muted);font-size:.9rem}
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
</head>
<body>
  <div id="userBg"></div>
  <header>
    <div class="container nav">
      <div class="brand">
        <span id="siteTitle" contenteditable="false" title="单击可编辑">旅行记忆本 · 与她的旅程</span>
        <span class="pill">单文件 · 在线地图 · 实时同步</span>
      </div>
      <div class="actions">
        <button class="btn primary" id="newEntry" type="button">＋新建</button>
        <details class="details-menu" id="menu">
          <summary class="btn">菜单 ▾</summary>
          <div class="menu card" style="position:absolute;right:0;top:calc(100% + .4rem);min-width:260px">
            <div class="title">主题</div>
            <div class="group">
              <select class="btn" id="themeSelect" aria-label="选择主题" style="width:100%">
                <option value="auto">跟随系统</option>
                <option value="light">浅色</option>
                <option value="dark">深色</option>
                <option value="sakura">樱花</option>
                <option value="ocean">海洋</option>
                <option value="forest">森林</option>
                <option value="warm">暖阳</option>
              </select>
            </div>
            <div class="title">背景</div>
            <div class="group">
              <input id="bgPick" type="file" accept="image/*" style="display:none" />
              <button class="btn" id="bgPickBtn" type="button">背景图片</button>
              <button class="btn danger" id="bgClearBtn" type="button">清除背景</button>
            </div>
            <div class="title">数据</div>
            <div class="group">
              <button class="btn" id="exportBtn" type="button">导出JSON（备份）</button>
              <button class="btn" id="importBtn" type="button">导入JSON（迁移）</button>
            </div>
            <div class="title">房间</div>
            <div class="group">
              <input id="roomInput" placeholder="roomId（留空=our-journey-room）" autocapitalize="off" autocomplete="off" autocorrect="off" />
              <button class="btn" id="roomApply" type="button">切换房间</button>
            </div>
          </div>
        </details>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <h1 id="heroTitle" contenteditable="false" title="单击可编辑" style="margin:.2rem 0 0">把你们的每一次出发，都留在这里</h1>
        <p class="help">支持标题、日期、地点、文字笔记，以及多张 <strong>照片</strong> 与 <strong>视频</strong>；内置 <strong>在线地图</strong>；iPhone Safari 适配。</p>

        <div class="row">
          <!-- 旅行语录 -->
          <div class="card">
            <h3>旅行语录</h3>
            <div id="quoteBox" class="quote" style="font-size:1.05rem;line-height:1.7">出发，才会遇见风景。<small>— 与她的旅程</small></div>
            <div style="display:flex;gap:.6rem;margin-top:.8rem;flex-wrap:wrap">
              <button class="icon-btn" id="quoteNext" type="button" aria-label="换一句">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h7m0 0L8 3m3 4-3 4M20 17h-7m0 0 3 4m-3-4 3-4"/></svg>
              </button>
              <button class="icon-btn" id="quoteToggle" type="button" aria-pressed="false" aria-label="自动轮换">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7-11-7z"/></svg>
              </button>
              <span id="quoteHint" class="help" style="align-self:center">自动轮换：关</span>
            </div>
            <p class="help" style="margin-top:.6rem">关闭页面后设置会自动记住。</p>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2 style="margin:.2rem 0 .6rem">旅行地图</h2>
      <div class="map-tools" style="margin:.4rem 0 .6rem">
        <button class="btn" id="mapFit" type="button">自动缩放到全部足迹</button>
        <span class="map-note">保存/导入记录后可点击“自动缩放”查看全部 Pin。</span>
      </div>
      <div id="mapWrap" class="card">
        <div id="map" role="region" aria-label="旅行地图"></div>
      </div>
    </section>

    <section class="section">
      <h2 style="margin:.2rem 0 .8rem">旅程列表</h2>

      <!-- 搜索 -->
      <div class="searchbar">
        <input id="searchInput" placeholder="搜索：标题 / 地点 / 标签 / 备注 / 日期（例如 2025-11）" autocomplete="off" autocapitalize="off" autocorrect="off">
        <button class="btn" id="searchClear" type="button" aria-label="清除搜索">清除</button>
      </div>

      <div id="empty" class="help" style="display:none">还没有记录，点击右上角 <strong>新建</strong> 试试吧～</div>
      <div id="noResult" class="help" style="display:none">没有匹配的结果，试试更短或不同的关键词。</div>
      <div id="list" class="list"></div>
      <div id="pager" class="pager" style="display:none">
        <button class="btn" id="prevPage" type="button">上一页</button>
        <span class="info" id="pageInfo">1 / 1</span>
        <button class="btn" id="nextPage" type="button">下一页</button>
      </div>
    </section>
  </main>

  <!-- 记录详细 / 编辑 -->
  <dialog id="entryDialog" aria-label="旅程编辑">
    <form method="dialog">
      <div class="modal-head">
        <strong id="dialogTitle">旅程</strong>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button class="btn danger" id="delBtn" type="button">删除</button>
          <button class="btn" value="cancel" id="closeEntry" type="button">关闭</button>
          <button class="btn primary" id="saveBtn" type="button">保存</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label for="title">标题</label>
            <input id="title" placeholder="例如：2025.11 富士山两日行" required
                   autocomplete="off" autocapitalize="off" autocorrect="off">
          </div>
          <div>
            <label for="date">日期</label>
            <input id="date" type="date">
          </div>
        </div>
        <br>
        <div class="row">
          <div>
            <label for="place">地点（用于搜索坐标）</label>
            <input id="place" placeholder="城市 / 景点，如：河口湖"
                   autocomplete="off" autocapitalize="off" autocorrect="off">
          </div>
          <div>
            <label for="tag">标签</label>
            <input id="tag" placeholder="例如：樱花、海岛、蜜月" autocomplete="off">
          </div>
        </div>
        <br>
        <div class="row">
          <div>
            <label>坐标（可手动或从地图拾取）</label>
            <div class="row" style="grid-template-columns:1fr 1fr">
              <input id="lat" placeholder="纬度，例如：35.3606" inputmode="decimal" autocapitalize="off" autocorrect="off">
              <input id="lng" placeholder="经度，例如：138.7274" inputmode="decimal" autocapitalize="off" autocorrect="off">
            </div>
            <div style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="geocodeBtn" type="button">根据地点自动定位</button>
              <button class="btn" id="pickOnMapBtn" type="button">在地图上拾取坐标</button>
            </div>
            <p class="help">备注：优先使用坐标；若无坐标则用地点名称在线搜索。</p>
          </div>
          <div>
            <label for="notes">文字记录</label>
            <textarea id="notes" rows="6" placeholder="写下这趟旅行的小故事吧～"></textarea>
          </div>
        </div>
        <br>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
            <div>
              <strong>照片 / 视频</strong>
              <p class="help">一次可多选；支持 <code>.jpg .png .webp .gif</code> 与 <code>.mp4 .webm</code>。iPhone：选相册请点“从相册/文件”；想直接拍摄请点“打开相机”。</p>
            </div>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <!-- ✅ 相册/文件（无 capture，支持进照片库/文件，多选） -->
              <input id="filePickLibrary" type="file" accept="image/*,video/*" multiple style="display:none">
              <button class="btn" id="pickFromLibraryBtn" type="button">从相册/文件</button>

              <!-- ✅ 相机直拍（保留 capture） -->
              <input id="filePickCamera" type="file" accept="image/*,video/*" multiple style="display:none" capture="environment">
              <button class="btn" id="pickFromCameraBtn" type="button">打开相机</button>

              <button class="btn danger" id="clearMedia" type="button">清空媒体</button>
            </div>
          </div>
          <div id="gallery" class="gallery" style="margin-top:.8rem"></div>
        </div>
      </div>
    </form>
  </dialog>

  <!-- 地图拾取坐标对话框 -->
  <dialog id="pickDialog" aria-label="选择坐标">
    <div class="modal-head">
      <span>在地图上选择坐标</span>
      <div style="display:flex;gap:.5rem">
        <button class="btn" id="pickUseBtn" type="button">使用该坐标</button>
        <button class="btn" id="pickCloseBtn" type="button">关闭</button>
      </div>
    </div>
    <div class="modal-body">
      <div id="pickMap" style="height:420px;border-radius:16px;border:1px solid var(--outline)"></div>
      <p class="help" id="pickInfo" style="margin-top:.5rem">点击地图落点；可缩放、拖动。</p>
    </div>
  </dialog>

  <!-- 预览大图/视频 -->
  <dialog id="viewer" aria-label="预览">
    <div class="modal-head">
      <span>预览</span>
      <button class="btn" id="viewerClose" type="button">关闭</button>
    </div>
    <div class="modal-body" id="viewerBody"></div>
  </dialog>

  <footer>
    <div class="container">
      <small>© <span id="year"></span> 与她的旅程 · 单文件旅行记忆本</small>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- 简易 dialog polyfill（iOS 老版本） -->
  <script>
    (function(){
      if (typeof HTMLDialogElement === 'function' && HTMLDialogElement.prototype.showModal) return;
      function polyfillDialog(dlg){
        if (dlg.__polyfilled) return;
        dlg.__polyfilled = true;
        dlg.showModal = function(){
          if (this.open) return;
          this.open = true;
          this._backdrop = document.createElement('div');
          this._backdrop.className = 'dlg-backdrop';
          document.body.appendChild(this._backdrop);
          const panel = document.createElement('div');
          panel.className = 'dlg-panel';
          while (this.firstChild) panel.appendChild(this.firstChild);
          this._panel = panel;
          const host = document.createElement('div');
          host.className = 'dlg-open';
          host.appendChild(panel);
          this._host = host;
          document.body.appendChild(host);
        };
        dlg.close = function(){
          if (!this.open) return;
          this.open = false;
          if (this._host){ document.body.removeChild(this._host); this._host=null; }
          if (this._backdrop){ document.body.removeChild(this._backdrop); this._backdrop=null; }
        };
      }
      document.querySelectorAll('dialog').forEach(polyfillDialog);
    })();
  </script>

  <!-- Firebase + 逻辑 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot,
      query, orderBy, serverTimestamp, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    if (!('randomUUID' in crypto)) {
      crypto.randomUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
      });
    }

    // === Firebase 配置 ===
    const firebaseConfig = {
      apiKey: "AIzaSyDuYmrNWhU5vXWpoEVk4IKamkuIjbH6AIo",
      authDomain: "travel-c2459.firebaseapp.com",
      projectId: "travel-c2459",
      storageBucket: "travel-c2459.firebasestorage.app",
      messagingSenderId: "142843430252",
      appId: "1:142843430252:web:089ef1595fc4db65cc9f49",
      measurementId: "G-EK5CCWX8QN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    try { await enableIndexedDbPersistence(db); } catch(e) { console.warn('IndexedDB 不可用，已降级。'); }

    // 房间
    const urlParams = new URLSearchParams(location.search);
    let roomId = urlParams.get("room") || "our-journey-room";
    const roomInput = document.getElementById('roomInput');
    const roomApply = document.getElementById('roomApply');
    if (roomInput) roomInput.value = roomId;
    roomApply?.addEventListener('click', ()=>{
      const r = (roomInput.value||"").trim() || "our-journey-room";
      const u = new URL(location.href); u.searchParams.set('room', r);
      location.href = u.toString();
    });

    await signInAnonymously(auth);
    const $ = (sel)=> document.querySelector(sel);

    /* ============ 主题 & 背景 ============ */
    const prefersDark = matchMedia('(prefers-color-scheme: dark)');
    const themeSelect = $('#themeSelect');
    function applyTheme(mode){
      try{
        if(mode==='auto'){ document.documentElement.setAttribute('data-theme', prefersDark.matches? 'dark':'light'); }
        else { document.documentElement.setAttribute('data-theme', mode); }
        localStorage.setItem('tj_theme', mode);
      }catch(e){}
    }
    const savedMode = localStorage.getItem('tj_theme') || 'auto';
    if(themeSelect) themeSelect.value = savedMode;
    applyTheme(savedMode);
    prefersDark.addEventListener('change', ()=>{ if((localStorage.getItem('tj_theme')||'auto')==='auto') applyTheme('auto'); });
    const menu = $('#menu');
    themeSelect?.addEventListener('change', (e)=>{ applyTheme(e.target.value); menu?.removeAttribute('open'); setTimeout(()=>{ map?.invalidateSize?.(); }, 80); });

    const userBgEl = $('#userBg');
    $('#bgPickBtn')?.addEventListener('click', ()=>{ $('#bgPick')?.click(); menu?.removeAttribute('open'); });
    $('#bgPick')?.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const dataUrl = await fileToDataURL(f);
      userBgEl?.style.setProperty('--user-bg', `url("${dataUrl}")`);
      try{ localStorage.setItem('tj_user_bg', dataUrl); }catch{}
      e.target.value='';
    });
    $('#bgClearBtn')?.addEventListener('click', ()=>{
      if(confirm('移除自定义背景？')){ userBgEl?.style.setProperty('--user-bg','none'); try{ localStorage.removeItem('tj_user_bg'); }catch{} }
      menu?.removeAttribute('open');
    });
    try{ const savedBg = localStorage.getItem('tj_user_bg'); if (savedBg) userBgEl?.style.setProperty('--user-bg', `url("${savedBg}")`); }catch{}

    // 标题可编辑
    const TITLE_MAIN_KEY='tj_title_main', TITLE_HERO_KEY='tj_title_hero';
    const siteTitleEl = $('#siteTitle'), heroTitleEl = $('#heroTitle');
    try{
      const t1 = localStorage.getItem(TITLE_MAIN_KEY);
      const t2 = localStorage.getItem(TITLE_HERO_KEY);
      if(t1) siteTitleEl.textContent = t1;
      if(t2) heroTitleEl.textContent = t2;
      if(t1) document.title = t1 + '（实时同步版）';
    }catch{}
    function enableEdit(el){
      if(!el) return; el.setAttribute('contenteditable','true'); el.focus();
      const r=document.createRange(); r.selectNodeContents(el); r.collapse(false);
      const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }
    function finalizeEdit(el, key){
      if(!el) return;
      const val = (el.textContent||'').replace(/[\u0000-\u001F\u007F]/g,'').trim();
      el.textContent = val || el.getAttribute('data-default') || el.textContent;
      try{ localStorage.setItem(key, el.textContent); }catch{}
      if(el===siteTitleEl) document.title = (el.textContent||'旅行记忆本 · 与她的旅程') + '（实时同步版）';
      el.setAttribute('contenteditable','false');
    }
    siteTitleEl?.addEventListener('click', ()=> enableEdit(siteTitleEl));
    heroTitleEl?.addEventListener('click', ()=> enableEdit(heroTitleEl));
    siteTitleEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); siteTitleEl.blur(); }});
    heroTitleEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); heroTitleEl.blur(); }});
    siteTitleEl?.addEventListener('blur', ()=> finalizeEdit(siteTitleEl, TITLE_MAIN_KEY));
    heroTitleEl?.addEventListener('blur', ()=> finalizeEdit(heroTitleEl, TITLE_HERO_KEY));

    /* ============ Firestore 实时数据流（旅程） ============ */
    let entries = [];       // 当前房间的旅程数据（经排序）
    let tempMedia = [];     // 编辑弹窗临时媒体
    let map, markersLayer;  // 地图
    let searchTerm = '';    // 搜索关键词
    let page=1, pageSize=10;

    const colRef = collection(db, "rooms", roomId, "entries");
    const qy = query(colRef, orderBy("updatedAt","desc"));

    onAuthStateChanged(auth, ()=>{
      onSnapshot(qy, (snap)=>{
        entries = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        entries = sortEntriesByDateDesc(entries); // 日期倒序（日期无效时 fallback 到 updatedAt）
        page = 1;
        renderList(); refreshMapMarkers();
      });
    });

    /* ============ 列表渲染、搜索、分页 ============ */
    const list=$('#list'), empty=$('#empty'), noResult=$('#noResult');
    const pager=$('#pager'), prevPage=$('#prevPage'), nextPage=$('#nextPage'), pageInfo=$('#pageInfo']);
    const searchInput = $('#searchInput'), searchClear = $('#searchClear');

    function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function firstMediaSrc(e){ const m=e.media?.[0]; return m? (m.url||m.preview):null; }

    function getEntryTime(e){
      if (e?.date) {
        const t = Date.parse(e.date);
        if (!Number.isNaN(t)) return t;
      }
      const u = e?.updatedAt;
      if (u && typeof u.toMillis === 'function') return u.toMillis();
      if (typeof u === 'number') return u;
      return 0;
    }
    function sortEntriesByDateDesc(arr){
      return (arr||[]).slice().sort((a,b)=> getEntryTime(b) - getEntryTime(a));
    }

    function getFilteredEntries(){
      const term = (searchTerm||'').trim().toLowerCase();
      if(!term) return entries;
      return entries.filter(e=>{
        const hay = [e.title||'', e.place||'', e.tag||'', e.notes||'', e.date||''].join(' ').toLowerCase();
        return hay.includes(term);
      });
    }

    function renderList(){
      if(!list||!empty||!noResult) return;
      list.innerHTML='';
      const data = getFilteredEntries();
      const hasAny = entries.length>0;
      empty.style.display = hasAny? 'none':'block';
      noResult.style.display = (hasAny && data.length===0 && searchTerm)? 'block':'none';
      if(!data.length){ pager.style.display='none'; return; }

      // 分页
      const total = data.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.min(Math.max(1, page), totalPages);
      const start = (page-1)*pageSize;
      const slice = data.slice(start, start+pageSize);

      for(const e of slice){
        const card=document.createElement('div'); card.className='card entry';
        const src=firstMediaSrc(e);
        const thumbInner = src
          ? (e.media[0].type==='image'
              ? `<img class="thumb" src="${src}" alt="thumb">`
              : `<video class="thumb" src="${src}" muted playsinline></video>`)
          : '<div class="thumb"></div>';
        const thumb = `<button class="thumb-btn" data-open="${e.id}" type="button" aria-label="查看/编辑">${thumbInner}</button>`;

        const hasCoord = (typeof e.lat==='number' && typeof e.lng==='number');
        card.innerHTML=`${thumb}
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
              <h3 style="margin:.2rem 0">${escapeHtml(e.title||'未命名')}</h3>
              <div style="display:flex;gap:.4rem;flex-wrap:wrap">
                <button class="btn" data-open="${e.id}" type="button">查看/编辑</button>
                <button class="btn" data-center="${e.id}" ${hasCoord? '':'disabled'} type="button">在地图上定位</button>
                <button class="btn danger" data-del="${e.id}" type="button">删除</button>
              </div>
            </div>
            <div class="meta">
              ${e.date?`<span>📅 ${e.date}</span>`:''}
              ${e.place?`<span>📍 ${escapeHtml(e.place)}</span>`:''}
              ${e.tag?`<span>🏷️ ${escapeHtml(e.tag)}</span>`:''}
              <span>🖼️ ${e.media?.length||0} 项</span>
              ${hasCoord? `<span>📌 ${e.lat?.toFixed?.(4)}, ${e.lng?.toFixed?.(4)}</span>`:''}
            </div>
            ${e.notes? `<p class="help" style="margin:.4rem 0 0">${escapeHtml(e.notes).slice(0,160)}${e.notes.length>160?'…':''}</p>`:''}
          </div>`;
        list.appendChild(card);
      }

      // 渲染分页条
      pageInfo.textContent = `${page} / ${Math.max(1,totalPages)}`;
      prevPage.disabled = (page<=1);
      nextPage.disabled = (page>=totalPages);
      pager.style.display='flex';
    }

    searchInput?.addEventListener('input', (e)=>{ searchTerm = e.target.value||''; page=1; renderList(); });
    searchClear?.addEventListener('click', ()=>{ searchTerm=''; if(searchInput) searchInput.value=''; page=1; renderList(); });
    prevPage?.addEventListener('click', ()=>{ if(page>1){ page--; renderList(); }});
    nextPage?.addEventListener('click', ()=>{ page++; renderList(); });

    // 新建 / 编辑 / 删除
    const entryDialog = $('#entryDialog');
    const dialogTitle = $('#dialogTitle');
    const titleEl=$('#title'), dateEl=$('#date'), placeEl=$('#place'), tagEl=$('#tag'), notesEl=$('#notes');
    const latEl=$('#lat'), lngEl=$('#lng');
    const gallery=$('#gallery');
    let editingId=null;

    $('#newEntry')?.addEventListener('click', ()=> openEditor());

    list?.addEventListener('click', async (ev)=>{
      const t = ev.target.closest?.('button'); if(!t) return;
      const openId = t.getAttribute('data-open');
      const delId = t.getAttribute('data-del');
      const centerId = t.getAttribute('data-center');
      if(openId){ const it = entries.find(x=>x.id===openId); openEditor(it); }
      if(delId){
        if(confirm('确定删除这条记录吗？')){
          await deleteDoc(doc(db, "rooms", roomId, "entries", delId));
        }
      }
      if(centerId){
        const it = entries.find(x=>x.id===centerId);
        if(it && typeof it.lat==='number' && typeof it.lng==='number'){ initMapOnce(); map?.setView([it.lat,it.lng], 10, {animate:true}); }
      }
    });

    $('#closeEntry')?.addEventListener('click', ()=> closeDialog(entryDialog));

    function openEditor(entry){
      editingId = entry?.id || null;
      dialogTitle && (dialogTitle.textContent = entry? '编辑记录':'新建记录');
      titleEl && (titleEl.value = entry?.title || '');
      dateEl && (dateEl.value = entry?.date || '');
      placeEl && (placeEl.value = entry?.place || '');
      tagEl && (tagEl.value = entry?.tag || '');
      notesEl && (notesEl.value = entry?.notes || '');
      latEl && (latEl.value = (typeof entry?.lat==='number')? String(entry.lat):'');
      lngEl && (lngEl.value = (typeof entry?.lng==='number')? String(entry.lng):'');
      tempMedia = (entry?.media||[]).map(m=>({ ...m })); // 已有媒体只有 url
      renderGallery(tempMedia);
      $('#delBtn') && ($('#delBtn').style.display = entry? 'inline-flex':'none');
      openDialog(entryDialog);
      setTimeout(()=>{ pickMap?.invalidateSize?.(); }, 80);
    }

    function renderGallery(items){
      if(!gallery) return; gallery.innerHTML='';
      for(const m of items){
        const wrap=document.createElement('div'); wrap.className='media';
        const src = m.url || m.preview;
        wrap.setAttribute('data-id', m.id);
        wrap.innerHTML=`${m.type==='image'
            ? `<img src="${src}" alt="media">`
            : `<video src="${src}" muted playsinline></video>`}
          <span class="badge">${m.type==='image'?'图片':'视频'}</span>
          <div style="position:absolute;left:.4rem;top:.4rem;display:flex;gap:.3rem">
            <button class="btn" data-view="${m.id}" type="button">预览</button>
            <button class="btn danger" data-remove="${m.id}" type="button">移除</button>
          </div>`;
        const node = wrap.querySelector('img,video');
        if (m.preview && node) {
          node.addEventListener('load', ()=> URL.revokeObjectURL(m.preview), {once:true});
          node.addEventListener('loadeddata', ()=> URL.revokeObjectURL(m.preview), {once:true});
        }
        gallery.appendChild(wrap);
      }
    }

    // ✅ 新的两个入口：相册/文件 & 相机
    $('#pickFromLibraryBtn')?.addEventListener('click', ()=> $('#filePickLibrary')?.click());
    $('#pickFromCameraBtn')?.addEventListener('click', ()=> $('#filePickCamera')?.click());

    const handleFiles = async (fileList)=>{
      const files=[...fileList||[]];
      for(const f of files){
        const isVideo=f.type.startsWith('video/'); const isImage=f.type.startsWith('image/');
        if(!isVideo && !isImage) continue;
        const preview = URL.createObjectURL(f);
        tempMedia.push({ id:uid(), type:isVideo?'video':'image', name:f.name, file:f, preview });
      }
      renderGallery(tempMedia);
    };

    $('#filePickLibrary')?.addEventListener('change', async (e)=>{
      await handleFiles(e.target.files);
      e.target.value='';
    });
    $('#filePickCamera')?.addEventListener('change', async (e)=>{
      await handleFiles(e.target.files);
      e.target.value='';
    });

    gallery?.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('button'); if(!btn) return;
      const id=btn.getAttribute('data-view')||btn.getAttribute('data-remove');
      const idx=tempMedia.findIndex(x=>x.id===id);
      if(btn.hasAttribute('data-remove')){ if(idx>-1){ tempMedia.splice(idx,1); renderGallery(tempMedia); } }
      if(btn.hasAttribute('data-view')){ openViewer(tempMedia[idx]); }
    });

    $('#clearMedia')?.addEventListener('click', ()=>{ if(confirm('清空这条记录的所有媒体？')) { tempMedia = []; renderGallery(tempMedia); } });

    $('#saveBtn')?.addEventListener('click', async ()=>{
      const latNum = parseFloat(latEl?.value||'');
      const lngNum = parseFloat(lngEl?.value||'');
      const entryId = editingId || crypto.randomUUID();
      const base = {
        title: (titleEl?.value||'').trim()||'未命名旅程',
        date: dateEl?.value||'',
        place: (placeEl?.value||'').trim(),
        tag:(tagEl?.value||'').trim(),
        notes: notesEl?.value||'',
      };
      if(!Number.isNaN(latNum) && !Number.isNaN(lngNum)){ base.lat=latNum; base.lng=lngNum; }

      const processed = [];
      for(const m of tempMedia){
        if(m.file){
          if(m.type==='image'){
            const { blob, width, height } = await compressImage(m.file, 1920, .85);
            const u = await uploadMedia(roomId, entryId, blob, m.name);
            processed.push({ id:m.id, type:'image', name:m.name, url:u.url, width, height, bytes:u.bytes });
          }else{
            const u = await uploadMedia(roomId, entryId, m.file, m.name);
            processed.push({ id:m.id, type:'video', name:m.name, url:u.url, bytes:u.bytes });
          }
        }else if(m.url){
          processed.push(m);
        }
      }

      const docRef = doc(collection(db, "rooms", roomId, "entries"), entryId);
      await setDoc(docRef, { ...base, media: processed, updatedAt:serverTimestamp() }, { merge:true });
      closeDialog(entryDialog);
    });

    $('#delBtn')?.addEventListener('click', async ()=>{
      if(!editingId) return;
      if(confirm('确定删除这条记录吗？')){
        await deleteDoc(doc(db, "rooms", roomId, "entries", editingId));
        closeDialog(entryDialog);
      }
    });

    // 导出/导入
    $('#exportBtn')?.addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(entries, null, 2)], {type:'application/json;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`trip_journal_${roomId}.json`; a.click(); URL.revokeObjectURL(a.href); menu?.removeAttribute('open');
    });
    $('#importBtn')?.addEventListener('click', ()=>{
      const i=document.createElement('input'); i.type='file'; i.accept='application/json';
      i.onchange=async ()=>{
        const f=i.files && i.files[0]; if(!f) return;
        const text=await f.text();
        try{
          const data=JSON.parse(text);
          if(!Array.isArray(data)) throw new Error('bad format');
          if(!confirm('导入会把 JSON 中的记录写入当前房间（媒体的 dataURL 将被重新上传）。继续？')) return;
          for(const e of data){
            const eid = e.id || crypto.randomUUID();
            const media = [];
            for(const m of e.media||[]){
              if(m.dataUrl?.startsWith('data:')){
                const blob = await (await fetch(m.dataUrl)).blob();
                const up = await uploadMedia(roomId, eid, blob, m.name||'media');
                media.push({ id:m.id||crypto.randomUUID(), type:m.type, name:m.name, url:up.url, bytes:up.bytes });
              } else if (m.url) {
                media.push(m);
              }
            }
            await setDoc(doc(collection(db,"rooms",roomId,"entries"), eid),
              { title:e.title||'', date:e.date||'', place:e.place||'', tag:e.tag||'', notes:e.notes||'', lat:e.lat||null, lng:e.lng||null, media, updatedAt:serverTimestamp() },
              { merge:true });
          }
          alert('导入完成');
        }catch{ alert('导入失败：格式不正确'); }
      };
      i.click(); menu?.removeAttribute('open');
    });

    /* ============ 预览器 ============ */
    const viewer=$('#viewer'), viewerBody=$('#viewerBody');
    function openViewer(m){
      if(!viewer||!viewerBody) return;
      const src = m.url || m.preview;
      viewerBody.innerHTML = m.type==='image'
        ? `<img src="${src}" style="max-width:100%">`
        : `<video src="${src}" controls playsinline style="max-width:100%"></video>`;
      openDialog(viewer);
    }
    $('#viewerClose')?.addEventListener('click',()=> closeDialog(viewer));

    /* ============ 地图（Leaflet） ============ */
    function initMap(){
      if(map) return;
      map = L.map('map', { zoomControl:true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap 贡献者'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      map.setView([1.3521,103.8198], 4);
      setTimeout(()=> map.invalidateSize(), 100);
    }
    function markerPopupHtml(e){
      const m=e.media?.[0]; const src = m? (m.url||m.preview):null;
      const mediaHtml = src? (m.type==='image'
        ? `<img src="${src}" style="width:160px;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--outline)"`
        : `<video src="${src}" style="width:160px;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--outline)" muted playsinline></video>`) : '';
      return `<div style="min-width:180px">
        <div style="font-weight:700;margin-bottom:.25rem">${escapeHtml(e.title||'未命名')}</div>
        ${e.date? `<div class="help" style="margin-bottom:.25rem">📅 ${e.date}</div>`:''}
        ${e.place? `<div class="help" style="margin-bottom:.25rem">📍 ${escapeHtml(e.place)}</div>`:''}
        ${mediaHtml}
      </div>`;
    }
    function refreshMapMarkers(){
      if(!map) return;
      markersLayer.clearLayers();
      const bounds=[];
      for(const e of entries){
        if(typeof e.lat==='number' && typeof e.lng==='number'){
          const m=L.marker([e.lat, e.lng]).bindPopup(markerPopupHtml(e));
          markersLayer.addLayer(m); bounds.push([e.lat,e.lng]);
        }
      }
      if(bounds.length){ map.fitBounds(bounds, {padding:[30,30]}); }
    }
    $('#mapFit')?.addEventListener('click', ()=>{ initMapOnce(); refreshMapMarkers(); });

    // 地图拾取坐标
    const pickDialog=$('#pickDialog'); const pickInfo=$('#pickInfo');
    let pickMap, pickMarker; let tempPick = {lat:null, lng:null};
    function openPickMap(){
      openDialog(pickDialog);
      setTimeout(()=>{
        if(!pickMap){
          pickMap = L.map('pickMap');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(pickMap);
          pickMap.setView([1.3521,103.8198], 4);
          pickMap.on('click', (ev)=>{
            const {lat, lng} = ev.latlng;
            tempPick = {lat, lng};
            if(!pickMarker){ pickMarker = L.marker([lat,lng]).addTo(pickMap); }
            else { pickMarker.setLatLng([lat,lng]); }
            pickInfo.textContent = `已选择：${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          });
        } else { pickMap.invalidateSize(); }
      }, 120);
    }
    $('#pickOnMapBtn')?.addEventListener('click', openPickMap);
    $('#pickCloseBtn')?.addEventListener('click', ()=> closeDialog(pickDialog));
    $('#pickUseBtn')?.addEventListener('click', ()=>{
      if(tempPick.lat!=null && tempPick.lng!=null){
        $('#lat').value = String(tempPick.lat);
        $('#lng').value = String(tempPick.lng);
        closeDialog(pickDialog);
      } else { alert('请先在地图上点击选择一个位置'); }
    });

    // 在线地理编码（Nominatim）
    const GEO_KEY='tj_geo_cache_v1';
    let geoCache = {};
    try{ geoCache = JSON.parse(localStorage.getItem(GEO_KEY)||'{}'); }catch{ geoCache = {} }
    async function geocodePlace(place){
      const key = place.trim().toLowerCase(); if(!key) return null;
      if(geoCache[key]) return geoCache[key];
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(place)}`;
      const res = await fetch(url, { headers: { 'Accept-Language':'zh-CN,zh;q=0.9,en;q=0.8' } });
      if(!res.ok) throw new Error('网络错误');
      const arr = await res.json();
      if(arr && arr[0]){
        const p = { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon) };
        geoCache[key]=p; try{ localStorage.setItem(GEO_KEY, JSON.stringify(geoCache)); }catch{}
        return p;
      }
      return null;
    }
    $('#geocodeBtn')?.addEventListener('click', async ()=>{
      const name = ($('#place')?.value||'').trim(); if(!name){ alert('请先填写地点名称'); return; }
      const btn = $('#geocodeBtn'); const old = btn.textContent; btn.disabled=true; btn.textContent='定位中…';
      try{
        const p = await geocodePlace(name);
        if(p){ $('#lat').value = String(p.lat); $('#lng').value = String(p.lng); alert('已写入坐标'); }
        else { alert('没有找到该地点的坐标，请尝试换个写法或手动拾取'); }
      }catch(e){ alert('网络或服务暂时不可用，请稍后再试'); }
      finally{ btn.disabled=false; btn.textContent=old; }
    });

    /* ============ 旅行语录（小图标） ============ */
    const QUOTE_KEY='tj_quote_auto';
    const quotes = [
      ['旅行的意义，是和喜欢的人一起把世界变小。','— 与她的旅程'],
      ['要么读书，要么旅行，灵魂和身体，必须有一个在路上。','— 佚名'],
      ['人生的目的地不重要，重要的是沿途的风景和看风景的心情。','— 林清玄（传）'],
      ['出发并不伟大，能一起出发才浪漫。','— 与她的旅程'],
      ['和你在一起，哪里都是远方。','— 与她的旅程'],
      ['世界很大，刚好我们一起。','— 与她的旅程'],
      ['最好的时光，是在路上，也是在人群中找到你。','— 与她的旅程'],
      ['把喜欢的一切装进行囊：阳光、海风、和你的笑。','— 与她的旅程']
    ];
    const quoteBox = $('#quoteBox'), quoteNext = $('#quoteNext'), quoteToggle = $('#quoteToggle'), quoteHint=$('#quoteHint']);
    let autoTimer=null, autoOn = (localStorage.getItem(QUOTE_KEY)||'0')==='1';

    function pickQuote(){
      const [txt, from] = quotes[Math.floor(Math.random()*quotes.length)];
      if(quoteBox) quoteBox.innerHTML = `${escapeHtml(txt)}<small>${escapeHtml(from)}</small>`;
    }
    function applyAuto(on){
      autoOn = !!on;
      quoteToggle?.setAttribute('aria-pressed', on?'true':'false');
      if(quoteHint) quoteHint.textContent = `自动轮换：${on?'开':'关'}`;
      try{ localStorage.setItem(QUOTE_KEY, on?'1':'0'); }catch{}
      if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
      if(on){ autoTimer = setInterval(pickQuote, 6000); }
    }
    quoteNext?.addEventListener('click', pickQuote);
    quoteToggle?.addEventListener('click', ()=> applyAuto(!autoOn));
    pickQuote(); applyAuto(autoOn);

    /* ============ 工具 ============ */
    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
    async function fileToDataURL(file){
      return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }
    async function compressImage(file, maxW=1920, quality=.85){
      const img = new Image(); img.src = URL.createObjectURL(file); await img.decode();
      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      const blob = await new Promise(res=> canvas.toBlob(res,'image/jpeg',quality));
      URL.revokeObjectURL(img.src);
      return { blob, width:w, height:h };
    }
    async function uploadMedia(roomId, entryId, fileOrBlob, filename){
      const mediaId = Math.random().toString(36).slice(2);
      const path = `rooms/${roomId}/${entryId}/${mediaId}-${(filename||'media').replace(/\s+/g,'_')}`;
      const r = ref(storage, path);
      const data = fileOrBlob;
      const snap = await uploadBytes(r, data);
      const url = await getDownloadURL(snap.ref);
      return { mediaId, url, bytes: data.size || 0 };
    }
    function openDialog(dlg){ if (!dlg) return; if (dlg.showModal) dlg.showModal(); else dlg.showModal?.(); }
    function closeDialog(dlg){ if (!dlg) return; if (dlg.close) dlg.close(); else dlg.close?.(); }

    // 初始化
    const y = document.getElementById('year'); if(y) y.textContent = new Date().getFullYear();
    function initMapOnce(){ if(!map){ initMap(); } else { setTimeout(()=> map.invalidateSize(), 100); } }
    initMapOnce();
  </script>
</body>
</html>
