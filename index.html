<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <!-- iPhone å®‰å…¨åŒºä¸è§†å£ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ—…è¡Œè®°å¿†æœ¬ Â· ä¸å¥¹çš„æ—…ç¨‹ï¼ˆFirebase å®æ—¶åŒæ­¥ç‰ˆ Â· iPhone ä¼˜åŒ–ï¼‰</title>
  <meta name="description" content="å•æ–‡ä»¶æ—…è¡Œè®°å½•æœ¬ï¼šæ”¯æŒæ–‡å­—ã€åœ°ç‚¹ã€æ—¶é—´ã€ç…§ç‰‡ä¸è§†é¢‘ï¼›å†…ç½®åœ¨çº¿åœ°å›¾ï¼ˆLeaflet + OSMï¼‰ï¼›é‡‡ç”¨ Firebase Firestore å®æ—¶åŒæ­¥ä¸ Storage å¤§å›¾å­˜å‚¨ã€‚">

  <style>
    :root{
      --bg:#0b0d12; --card:#121722; --text:#e6ebf4; --muted:#a9b4c8;
      --brand:#3b82f6; --accent:#22d3ee; --ring:rgba(59,130,246,.35);
      --outline:rgba(255,255,255,.10); --outline-2:rgba(255,255,255,.18);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    [data-theme="light"]{
      --bg:#f6f8fc; --card:#ffffff; --text:#111827; --muted:#5b677d;
      --brand:#2563eb; --accent:#06b6d4; --ring:rgba(37,99,235,.25);
      --outline:rgba(0,0,0,.08); --outline-2:rgba(0,0,0,.12);
    }

    html,body{height:100%}
    body{
      margin:0; background:var(--bg);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      color:var(--text);
      /* iPhone åº•éƒ¨æ‰‹åŠ¿æ¡å®‰å…¨åŒº */
      padding-bottom: var(--safe-bottom);
    }
    a{color:inherit;text-decoration:none}
    .container{width:min(1100px,90vw);margin-inline:auto}

    header{
      position:sticky;top:0;z-index:10;
      -webkit-backdrop-filter:saturate(160%) blur(10px);
      backdrop-filter:saturate(160%) blur(10px);
      background:rgba(17,23,34,.55);
      border-bottom:1px solid var(--outline);
      padding-top: calc(var(--safe-top) * 1); /* é¡¶éƒ¨å®‰å…¨åŒº */
    }
    [data-theme="light"] header{background:rgba(255,255,255,.7)}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:.5rem 0}
    .brand{font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:.5rem}
    .actions{display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}

    .btn{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:.55rem .9rem;border-radius:12px;border:1px solid var(--outline-2);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      color:var(--text);cursor:pointer;font-size:.95rem;-webkit-tap-highlight-color: transparent;
    }
    .btn.primary{background:linear-gradient(180deg,var(--brand),#1d4ed8);color:#fff;border:0}
    .btn:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .pill{display:inline-block;font-size:.78rem;color:var(--brand);background:rgba(59,130,246,.12);padding:.15rem .55rem;border-radius:999px;border:1px solid rgba(59,130,246,.25)}
    .section{padding:1.2rem 0 2.2rem}

    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:1rem;box-shadow:0 4px 16px rgba(0,0,0,.12)}
    .card h3{margin:.2rem 0 .6rem}

    .hero{position:relative;display:grid;grid-template-columns:1.1fr .9fr;align-items:center;gap:1.4rem;padding:1.2rem 0 .8rem}
    .hero::before{
      content:""; position:absolute; inset:-40px -100vw 40px -100vw; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(59,130,246,.25), transparent),
        radial-gradient(900px 600px at -10% 10%, rgba(34,211,238,.18), transparent);
      -webkit-mask-image:linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,0) 70%);
              mask-image:linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,0) 70%);
    }
    @media (max-width:980px){.hero{grid-template-columns:1fr}}

    input,textarea,select{
      width:100%;padding:.75rem;border-radius:12px;border:1px solid var(--outline);background:transparent;color:var(--text);
      -webkit-appearance:none;appearance:none;
    }
    label{font-size:.9rem;color:var(--muted)}
    .help{color:var(--muted);font-size:.85rem}

    .list{display:grid;gap:1rem}
    .entry{display:grid;grid-template-columns:120px 1fr;gap:1rem;align-items:center}
    .thumb{width:120px;height:80px;object-fit:cover;border-radius:12px;border:1px solid var(--outline-2);background:#00000022}
    .meta{display:flex;gap:.6rem;flex-wrap:wrap;color:var(--muted);font-size:.9rem}

    .gallery{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem}
    @media (max-width:980px){.gallery{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.gallery{grid-template-columns:repeat(2,1fr)}}
    .media{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--outline)}
    .media img,.media video{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;right:.4rem;top:.4rem;background:rgba(0,0,0,.45);color:#fff;padding:.1rem .4rem;border-radius:8px;font-size:.75rem}

    /* â€”â€” iOS å…¼å®¹ dialog â€”â€” */
    dialog{border:1px solid var(--outline);border-radius:18px;padding:0;background:var(--card);color:var(--text);width:min(980px,94vw)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--outline)}
    .modal-body{padding:1rem;max-height:min(72vh,820px);overflow:auto;-webkit-overflow-scrolling:touch}

    /* polyfill çŠ¶æ€ä¸‹çš„æ ·å¼ */
    .dlg-open{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
    .dlg-panel{background:var(--card);border:1px solid var(--outline);border-radius:18px;width:min(980px,94vw);max-height:min(72vh,820px);display:flex;flex-direction:column}
    .dlg-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9998}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media (max-width:640px){.row{grid-template-columns:1fr}}

    footer{border-top:1px solid var(--outline);padding:2rem 0;color:var(--muted);text-align:center}
    .illus{aspect-ratio:4/3;border-radius:20px;border:1px solid var(--outline);
      background:
        radial-gradient(80% 60% at 30% 20%, rgba(34,211,238,.25), transparent 60%),
        linear-gradient(135deg, rgba(59,130,246,.30), rgba(59,130,246,.05) 55%, transparent),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02))}

    /* å¤šä¸»é¢˜ & èƒŒæ™¯ */
    [data-theme="sakura"]{ --bg:#1a1325; --card:#20172d; --text:#fdeaf6; --muted:#d9c0d8; --brand:#ec4899; --accent:#fb7185; --ring:rgba(236,72,153,.30); }
    [data-theme="ocean"] { --bg:#08121a; --card:#0f1b27; --text:#e6f6ff; --muted:#a0c3d7; --brand:#06b6d4; --accent:#22d3ee; --ring:rgba(6,182,212,.30); }
    [data-theme="forest"]{ --bg:#0b130f; --card:#111c16; --text:#e9faef; --muted:#b2d3bc; --brand:#22c55e; --accent:#16a34a; --ring:rgba(34,197,94,.30); }
    [data-theme="warm"]  { --bg:#18110b; --card:#1f1710; --text:#fff4e5; --muted:#e6d1bb; --brand:#f59e0b; --accent:#f97316; --ring:rgba(245,158,11,.30); }
    #userBg{position:fixed; inset:0; background:var(--user-bg, none); background-size:cover; background-position:center; background-repeat:no-repeat; opacity:var(--user-bg-opacity, .22); pointer-events:none; z-index:-1}

    [contenteditable="true"]{outline:2px dashed transparent;border-radius:10px;transition:.2s}
    [contenteditable="true"]:hover{outline-color:rgba(255,255,255,.12)}
    [data-theme="light"] [contenteditable="true"]:hover{outline-color:rgba(0,0,0,.1)}
    [contenteditable="true"]:focus{outline-color:var(--accent);background-color:rgba(255,255,255,.03)}
    [data-theme="light"] [contenteditable="true"]:focus{background-color:rgba(0,0,0,.03)}

    /* åœ°å›¾ */
    #mapWrap{margin-top:.6rem}
    #map{height:420px;border-radius:16px;border:1px solid var(--outline);overflow:hidden}
    .leaflet-container{font:inherit; touch-action: pan-x pan-y;}
    .map-tools{display:flex;gap:.5rem;flex-wrap:wrap}
    .map-note{font-size:.85rem;color:var(--muted)}
  </style>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
</head>
<body>
  <div id="userBg"></div>
  <header>
    <div class="container nav">
      <div class="brand">
        <span id="siteTitle" contenteditable="false" title="å•å‡»å¯ç¼–è¾‘">æ—…è¡Œè®°å¿†æœ¬ Â· ä¸å¥¹çš„æ—…ç¨‹</span>
        <span class="pill">å•æ–‡ä»¶ Â· åœ¨çº¿åœ°å›¾ Â· å®æ—¶åŒæ­¥</span>
      </div>
      <div class="actions">
        <button class="btn primary" id="newEntry" type="button">ï¼‹æ–°å»º</button>
        <details class="details-menu" id="menu">
          <summary class="btn">èœå• â–¾</summary>
          <div class="menu card" style="position:absolute;right:0;top:calc(100% + .4rem);min-width:260px">
            <div class="title">ä¸»é¢˜</div>
            <div class="group">
              <select class="btn" id="themeSelect" aria-label="é€‰æ‹©ä¸»é¢˜" style="width:100%">
                <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
                <option value="light">æµ…è‰²</option>
                <option value="dark">æ·±è‰²</option>
                <option value="sakura">æ¨±èŠ±</option>
                <option value="ocean">æµ·æ´‹</option>
                <option value="forest">æ£®æ—</option>
                <option value="warm">æš–é˜³</option>
              </select>
            </div>
            <div class="title">èƒŒæ™¯</div>
            <div class="group">
              <input id="bgPick" type="file" accept="image/*" style="display:none" />
              <button class="btn" id="bgPickBtn" type="button">èƒŒæ™¯å›¾ç‰‡</button>
              <button class="btn danger" id="bgClearBtn" type="button">æ¸…é™¤èƒŒæ™¯</button>
            </div>
            <div class="title">æ•°æ®</div>
            <div class="group">
              <button class="btn" id="exportBtn" type="button">å¯¼å‡ºJSONï¼ˆå¤‡ä»½ï¼‰</button>
              <button class="btn" id="importBtn" type="button">å¯¼å…¥JSONï¼ˆè¿ç§»ï¼‰</button>
            </div>
            <div class="title">æˆ¿é—´</div>
            <div class="group">
              <input id="roomInput" placeholder="roomIdï¼ˆç•™ç©º=our-journey-roomï¼‰" autocapitalize="off" autocomplete="off" autocorrect="off" />
              <button class="btn" id="roomApply" type="button">åˆ‡æ¢æˆ¿é—´</button>
            </div>
          </div>
        </details>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <h1 id="heroTitle" contenteditable="false" title="å•å‡»å¯ç¼–è¾‘" style="margin:.2rem 0 0">æŠŠä½ ä»¬çš„æ¯ä¸€æ¬¡å‡ºå‘ï¼Œéƒ½ç•™åœ¨è¿™é‡Œ</h1>
        <p class="help">æ”¯æŒæ ‡é¢˜ã€æ—¥æœŸã€åœ°ç‚¹ã€æ–‡å­—ç¬”è®°ï¼Œä»¥åŠå¤šå¼  <strong>ç…§ç‰‡</strong> ä¸ <strong>è§†é¢‘</strong>ï¼›å¹¶å†…ç½®ä¸€å¼  <strong>åœ¨çº¿åœ°å›¾</strong>ï¼Œå¯ä¸€é”®æŠŠåœ°ç‚¹è½¬ä¸º Pinï¼Œæˆ–æ‰‹åŠ¨ç‚¹åœ°å›¾è½ Pinã€‚</p>
        <div class="row">
          <div class="card">
            <h3>å¦‚ä½•ä¸å¥¹åŒæ­¥ï¼Ÿ</h3>
            <ol class="help">
              <li>ä¸¤äººä½¿ç”¨åŒä¸€ä»½ <code>.html</code> æ–‡ä»¶ã€‚</li>
              <li>åŒä¸€ä¸ª <strong>roomId</strong>ï¼ˆåœ°å€æ  <code>?room=â€¦</code> æˆ–å³ä¸Šè§’â€œæˆ¿é—´â€ï¼‰ã€‚</li>
              <li>ä»»æ„ä¸€æ–¹æ–°å¢/ç¼–è¾‘ï¼Œå¦ä¸€æ–¹ä¼šå®æ—¶è‡ªåŠ¨å‡ºç°ã€‚</li>
            </ol>
            <p class="help">æç¤ºï¼šç¦»çº¿ä¹Ÿå¯å†™ï¼Œæ¢å¤ç½‘ç»œåè‡ªåŠ¨åˆå¹¶ã€‚</p>
          </div>
          <div class="illus card" aria-hidden="true"></div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2 style="margin:.2rem 0 .6rem">æ—…è¡Œåœ°å›¾</h2>
      <div class="map-tools" style="margin:.4rem 0 .6rem">
        <button class="btn" id="mapFit" type="button">è‡ªåŠ¨ç¼©æ”¾åˆ°å…¨éƒ¨è¶³è¿¹</button>
        <span class="map-note">ä¿å­˜/å¯¼å…¥è®°å½•åå¯ç‚¹å‡»â€œè‡ªåŠ¨ç¼©æ”¾â€æŸ¥çœ‹å…¨éƒ¨ Pinã€‚</span>
      </div>
      <div id="mapWrap" class="card">
        <div id="map" role="region" aria-label="æ—…è¡Œåœ°å›¾"></div>
      </div>
    </section>

    <section class="section">
      <h2 style="margin:.2rem 0 1rem">æ—…ç¨‹åˆ—è¡¨</h2>
      <div id="empty" class="help" style="display:none">è¿˜æ²¡æœ‰è®°å½•ï¼Œç‚¹å‡»å³ä¸Šè§’ <strong>æ–°å»º</strong> è¯•è¯•å§ï½</div>
      <div id="list" class="list"></div>
    </section>
  </main>

  <!-- è®°å½•è¯¦ç»† / ç¼–è¾‘ -->
  <dialog id="entryDialog" aria-label="æ—…ç¨‹ç¼–è¾‘">
    <form method="dialog">
      <div class="modal-head">
        <strong id="dialogTitle">æ—…ç¨‹</strong>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button class="btn danger" id="delBtn" type="button">åˆ é™¤</button>
          <button class="btn" value="cancel" id="closeEntry" type="button">å…³é—­</button>
          <button class="btn primary" id="saveBtn" type="button">ä¿å­˜</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label for="title">æ ‡é¢˜</label>
            <input id="title" placeholder="ä¾‹å¦‚ï¼š2025.11 å¯Œå£«å±±ä¸¤æ—¥è¡Œ" required
                   autocomplete="off" autocapitalize="off" autocorrect="off">
          </div>
          <div>
            <label for="date">æ—¥æœŸ</label>
            <input id="date" type="date">
          </div>
        </div>
        <br>
        <div class="row">
          <div>
            <label for="place">åœ°ç‚¹ï¼ˆç”¨äºæœç´¢åæ ‡ï¼‰</label>
            <input id="place" placeholder="åŸå¸‚ / æ™¯ç‚¹ï¼Œå¦‚ï¼šæ²³å£æ¹–"
                   autocomplete="off" autocapitalize="off" autocorrect="off">
          </div>
          <div>
            <label for="tag">æ ‡ç­¾</label>
            <input id="tag" placeholder="ä¾‹å¦‚ï¼šæ¨±èŠ±ã€æµ·å²›ã€èœœæœˆ" autocomplete="off">
          </div>
        </div>
        <br>
        <div class="row">
          <div>
            <label>åæ ‡ï¼ˆå¯æ‰‹åŠ¨æˆ–ä»åœ°å›¾æ‹¾å–ï¼‰</label>
            <div class="row" style="grid-template-columns:1fr 1fr">
              <input id="lat" placeholder="çº¬åº¦ï¼Œä¾‹å¦‚ï¼š35.3606" inputmode="decimal" autocapitalize="off" autocorrect="off">
              <input id="lng" placeholder="ç»åº¦ï¼Œä¾‹å¦‚ï¼š138.7274" inputmode="decimal" autocapitalize="off" autocorrect="off">
            </div>
            <div style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="geocodeBtn" type="button">æ ¹æ®åœ°ç‚¹è‡ªåŠ¨å®šä½</button>
              <button class="btn" id="pickOnMapBtn" type="button">åœ¨åœ°å›¾ä¸Šæ‹¾å–åæ ‡</button>
            </div>
            <p class="help">å¤‡æ³¨ï¼šä¼˜å…ˆä½¿ç”¨åæ ‡ï¼›è‹¥æ— åæ ‡åˆ™ç”¨åœ°ç‚¹åç§°åœ¨çº¿æœç´¢ã€‚</p>
          </div>
          <div>
            <label for="notes">æ–‡å­—è®°å½•</label>
            <textarea id="notes" rows="6" placeholder="å†™ä¸‹è¿™è¶Ÿæ—…è¡Œçš„å°æ•…äº‹å§ï½"></textarea>
          </div>
        </div>
        <br>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
            <div>
              <strong>ç…§ç‰‡ / è§†é¢‘</strong>
              <p class="help">ä¸€æ¬¡å¯å¤šé€‰ï¼›æ”¯æŒ <code>.jpg .png .webp .gif</code> ä¸ <code>.mp4 .webm</code>ã€‚</p>
            </div>
            <div style="display:flex;gap:.5rem">
              <!-- iPhoneï¼šå…è®¸ç›¸å†Œ/ç›¸æœºï¼Œå†…è”æ’­æ”¾ -->
              <input id="filePick" type="file" accept="image/*,video/*" multiple style="display:none" capture="environment">
              <button class="btn" id="pickBtn" type="button">æ·»åŠ æ–‡ä»¶</button>
              <button class="btn danger" id="clearMedia" type="button">æ¸…ç©ºåª’ä½“</button>
            </div>
          </div>
          <div id="gallery" class="gallery" style="margin-top:.8rem"></div>
        </div>
      </div>
    </form>
  </dialog>

  <!-- åœ°å›¾æ‹¾å–åæ ‡å¯¹è¯æ¡† -->
  <dialog id="pickDialog" aria-label="é€‰æ‹©åæ ‡">
    <div class="modal-head">
      <span>åœ¨åœ°å›¾ä¸Šé€‰æ‹©åæ ‡</span>
      <div style="display:flex;gap:.5rem">
        <button class="btn" id="pickUseBtn" type="button">ä½¿ç”¨è¯¥åæ ‡</button>
        <button class="btn" id="pickCloseBtn" type="button">å…³é—­</button>
      </div>
    </div>
    <div class="modal-body">
      <div id="pickMap" style="height:420px;border-radius:16px;border:1px solid var(--outline)"></div>
      <p class="help" id="pickInfo" style="margin-top:.5rem">ç‚¹å‡»åœ°å›¾è½ç‚¹ï¼›å¯ç¼©æ”¾ã€æ‹–åŠ¨ã€‚</p>
    </div>
  </dialog>

  <!-- é¢„è§ˆå¤§å›¾/è§†é¢‘ -->
  <dialog id="viewer" aria-label="é¢„è§ˆ">
    <div class="modal-head">
      <span>é¢„è§ˆ</span>
      <button class="btn" id="viewerClose" type="button">å…³é—­</button>
    </div>
    <div class="modal-body" id="viewerBody"></div>
  </dialog>

  <footer>
    <div class="container">
      <small>Â© <span id="year"></span> ä¸å¥¹çš„æ—…ç¨‹ Â· å•æ–‡ä»¶æ—…è¡Œè®°å¿†æœ¬</small>
    </div>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- ======= dialog è½»é‡ polyfillï¼ˆiOS è€ç‰ˆæœ¬ï¼‰ ======= -->
  <script>
    (function(){
      if (typeof HTMLDialogElement === 'function' && HTMLDialogElement.prototype.showModal) return;
      function polyfillDialog(dlg){
        if (dlg.__polyfilled) return;
        dlg.__polyfilled = true;
        dlg.showModal = function(){
          if (this.open) return;
          this.open = true;
          this._backdrop = document.createElement('div');
          this._backdrop.className = 'dlg-backdrop';
          document.body.appendChild(this._backdrop);

          const panel = document.createElement('div');
          panel.className = 'dlg-panel';
          while (this.firstChild) panel.appendChild(this.firstChild);
          this._panel = panel;

          const host = document.createElement('div');
          host.className = 'dlg-open';
          host.appendChild(panel);
          this._host = host;
          document.body.appendChild(host);
        };
        dlg.close = function(){
          if (!this.open) return;
          this.open = false;
          if (this._host){ document.body.removeChild(this._host); this._host=null; }
          if (this._backdrop){ document.body.removeChild(this._backdrop); this._backdrop=null; }
        };
      }
      document.querySelectorAll('dialog').forEach(polyfillDialog);
    })();
  </script>

  <!-- === Firebase é›†æˆï¼ˆCDN ESMï¼‰ + iPhone Safari å…¼å®¹å¢å¼º === -->
  <script type="module">
    /* ===== Firebase SDKï¼ˆv12.x ESMï¼‰ ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot,
      query, orderBy, serverTimestamp, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // ===== randomUUID å…œåº•ï¼ˆè€ iOSï¼‰ =====
    if (!('randomUUID' in crypto)) {
      crypto.randomUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
      });
    }

    // âœ… ä½ çš„ firebaseConfigï¼ˆä¿æŒä¸å˜ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyDuYmrNWhU5vXWpoEVk4IKamkuIjbH6AIo",
      authDomain: "travel-c2459.firebaseapp.com",
      projectId: "travel-c2459",
      storageBucket: "travel-c2459.firebasestorage.app",
      messagingSenderId: "142843430252",
      appId: "1:142843430252:web:089ef1595fc4db65cc9f49",
      measurementId: "G-EK5CCWX8QN"
    };

    // === åˆå§‹åŒ– ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    try { await enableIndexedDbPersistence(db); } catch(e) {
      // iOS ç§å¯†æ¨¡å¼ç­‰åœºæ™¯ä¼šå¤±è´¥ï¼Œé™é»˜é™çº§
      console.warn('IndexedDB æŒä¹…åŒ–ä¸å¯ç”¨ï¼Œå·²é™çº§è¿è¡Œã€‚');
    }

    // === ç™»å½•ï¼ˆåŒ¿åï¼‰ ===
    await signInAnonymously(auth);

    // â€”â€” æˆ¿é—´å·ï¼ˆ?room=xxxï¼›é»˜è®¤ our-journey-roomï¼‰
    const urlParams = new URLSearchParams(location.search);
    let roomId = urlParams.get("room") || "our-journey-room";
    const roomInput = document.getElementById('roomInput');
    const roomApply = document.getElementById('roomApply');
    if (roomInput) roomInput.value = roomId;
    roomApply?.addEventListener('click', ()=>{
      const r = (roomInput.value||"").trim() || "our-journey-room";
      const u = new URL(location.href); u.searchParams.set('room', r);
      location.href = u.toString();
    });

    const $ = (sel)=> document.querySelector(sel);

    // ä¸»é¢˜ & èƒŒæ™¯ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰
    const prefersDark = matchMedia('(prefers-color-scheme: dark)');
    const themeSelect = $('#themeSelect');
    const userBgEl = $('#userBg');
    const menu = $('#menu');

    function applyTheme(mode){
      try{
        if(mode==='auto'){ document.documentElement.setAttribute('data-theme', prefersDark.matches? 'dark':'light'); }
        else { document.documentElement.setAttribute('data-theme', mode); }
        localStorage.setItem('tj_theme', mode);
      }catch(e){}
    }
    const savedMode = localStorage.getItem('tj_theme') || 'auto';
    if(themeSelect) themeSelect.value = savedMode;
    applyTheme(savedMode);
    prefersDark.addEventListener('change', ()=>{ if((localStorage.getItem('tj_theme')||'auto')==='auto') applyTheme('auto'); });
    themeSelect?.addEventListener('change', (e)=>{ applyTheme(e.target.value); menu?.removeAttribute('open'); setTimeout(()=>{ map?.invalidateSize?.(); }, 80); });

    $('#bgPickBtn')?.addEventListener('click', ()=>{ $('#bgPick')?.click(); menu?.removeAttribute('open'); });
    $('#bgPick')?.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const dataUrl = await fileToDataURL(f);
      userBgEl?.style.setProperty('--user-bg', `url("${dataUrl}")`);
      try{ localStorage.setItem('tj_user_bg', dataUrl); }catch{}
      e.target.value='';
    });
    $('#bgClearBtn')?.addEventListener('click', ()=>{
      if(confirm('ç§»é™¤è‡ªå®šä¹‰èƒŒæ™¯ï¼Ÿ')){ userBgEl?.style.setProperty('--user-bg','none'); try{ localStorage.removeItem('tj_user_bg'); }catch{} }
      menu?.removeAttribute('open');
    });
    // è¯»å–å·²å­˜èƒŒæ™¯
    try{
      const savedBg = localStorage.getItem('tj_user_bg');
      if (savedBg) userBgEl?.style.setProperty('--user-bg', `url("${savedBg}")`);
    }catch{}

    // å¯ç¼–è¾‘æ ‡é¢˜ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰
    const TITLE_MAIN_KEY='tj_title_main', TITLE_HERO_KEY='tj_title_hero';
    const siteTitleEl = $('#siteTitle'), heroTitleEl = $('#heroTitle');
    try{
      const t1 = localStorage.getItem(TITLE_MAIN_KEY);
      const t2 = localStorage.getItem(TITLE_HERO_KEY);
      if(t1) siteTitleEl.textContent = t1;
      if(t2) heroTitleEl.textContent = t2;
      if(t1) document.title = t1 + 'ï¼ˆå®æ—¶åŒæ­¥ç‰ˆï¼‰';
    }catch{}
    function enableEdit(el){
      if(!el) return; el.setAttribute('contenteditable','true'); el.focus();
      const r=document.createRange(); r.selectNodeContents(el); r.collapse(false);
      const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }
    function finalizeEdit(el, key){
      if(!el) return;
      const val = (el.textContent||'').replace(/[\u0000-\u001F\u007F]/g,'').trim();
      el.textContent = val || el.getAttribute('data-default') || el.textContent;
      try{ localStorage.setItem(key, el.textContent); }catch{}
      if(el===siteTitleEl) document.title = (el.textContent||'æ—…è¡Œè®°å¿†æœ¬ Â· ä¸å¥¹çš„æ—…ç¨‹') + 'ï¼ˆå®æ—¶åŒæ­¥ç‰ˆï¼‰';
      el.setAttribute('contenteditable','false');
    }
    siteTitleEl?.addEventListener('click', ()=> enableEdit(siteTitleEl));
    heroTitleEl?.addEventListener('click', ()=> enableEdit(heroTitleEl));
    siteTitleEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); siteTitleEl.blur(); }});
    heroTitleEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); heroTitleEl.blur(); }});
    siteTitleEl?.addEventListener('blur', ()=> finalizeEdit(siteTitleEl, TITLE_MAIN_KEY));
    heroTitleEl?.addEventListener('blur', ()=> finalizeEdit(heroTitleEl, TITLE_HERO_KEY));

    // ===== Firestore å®æ—¶æ•°æ®æµ =====
    let entries = [];       // å½“å‰æˆ¿é—´æ•°æ®
    let tempMedia = [];     // ç¼–è¾‘å¼¹çª—å†…çš„ä¸´æ—¶åª’ä½“
    let map, markersLayer;  // åœ°å›¾

    const colRef = collection(db, "rooms", roomId, "entries");
    const qy = query(colRef, orderBy("updatedAt","desc"));

    onAuthStateChanged(auth, ()=>{
      onSnapshot(qy, (snap)=>{
        entries = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        renderList(); refreshMapMarkers();
      });
    });

    // ===== åˆ—è¡¨æ¸²æŸ“ =====
    const list=$('#list'), empty=$('#empty');
    function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function firstMediaSrc(e){ const m=e.media?.[0]; return m? (m.url||m.preview):null; }
    function renderList(){
      if(!list||!empty) return;
      list.innerHTML='';
      if(!entries.length){ empty.style.display='block'; return; }
      empty.style.display='none';
      for(const e of entries){
        const card=document.createElement('div'); card.className='card entry';
        const src=firstMediaSrc(e);
        const thumb = src? (e.media[0].type==='image'
          ? `<img class="thumb" src="${src}" alt="thumb">`
          : `<video class="thumb" src="${src}" muted playsinline></video>`) : '<div class="thumb"></div>';
        const hasCoord = (typeof e.lat==='number' && typeof e.lng==='number');
        card.innerHTML=`${thumb}
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
              <h3 style="margin:.2rem 0">${escapeHtml(e.title||'æœªå‘½å')}</h3>
              <div style="display:flex;gap:.4rem;flex-wrap:wrap">
                <button class="btn" data-open="${e.id}" type="button">æŸ¥çœ‹/ç¼–è¾‘</button>
                <button class="btn" data-center="${e.id}" ${hasCoord? '':'disabled'} type="button">åœ¨åœ°å›¾ä¸Šå®šä½</button>
                <button class="btn danger" data-del="${e.id}" type="button">åˆ é™¤</button>
              </div>
            </div>
            <div class="meta">
              ${e.date?`<span>ğŸ“… ${e.date}</span>`:''}
              ${e.place?`<span>ğŸ“ ${escapeHtml(e.place)}</span>`:''}
              ${e.tag?`<span>ğŸ·ï¸ ${escapeHtml(e.tag)}</span>`:''}
              <span>ğŸ–¼ï¸ ${e.media?.length||0} é¡¹</span>
              ${hasCoord? `<span>ğŸ“Œ ${e.lat?.toFixed?.(4)}, ${e.lng?.toFixed?.(4)}</span>`:''}
            </div>
            ${e.notes? `<p class="help" style="margin:.4rem 0 0">${escapeHtml(e.notes).slice(0,160)}${e.notes.length>160?'â€¦':''}</p>`:''}
          </div>`;
        list.appendChild(card);
      }
    }

    // ===== æ–°å»º / ç¼–è¾‘ / åˆ é™¤ =====
    const entryDialog = $('#entryDialog');
    const dialogTitle = $('#dialogTitle');
    const titleEl=$('#title'), dateEl=$('#date'), placeEl=$('#place'), tagEl=$('#tag'), notesEl=$('#notes');
    const latEl=$('#lat'), lngEl=$('#lng');
    const gallery=$('#gallery');
    let editingId=null;

    $('#newEntry')?.addEventListener('click', ()=> openEditor());

    list?.addEventListener('click', async (ev)=>{
      const t = ev.target.closest?.('button'); if(!t) return;
      const openId = t.getAttribute('data-open');
      const delId = t.getAttribute('data-del');
      const centerId = t.getAttribute('data-center');
      if(openId){ const it = entries.find(x=>x.id===openId); openEditor(it); }
      if(delId){
        if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')){
          await deleteDoc(doc(db, "rooms", roomId, "entries", delId));
        }
      }
      if(centerId){
        const it = entries.find(x=>x.id===centerId);
        if(it && typeof it.lat==='number' && typeof it.lng==='number'){ initMapOnce(); map?.setView([it.lat,it.lng], 10, {animate:true}); }
      }
    });

    $('#closeEntry')?.addEventListener('click', ()=> closeDialog(entryDialog));

    function openEditor(entry){
      editingId = entry?.id || null;
      dialogTitle && (dialogTitle.textContent = entry? 'ç¼–è¾‘è®°å½•':'æ–°å»ºè®°å½•');
      titleEl && (titleEl.value = entry?.title || '');
      dateEl && (dateEl.value = entry?.date || '');
      placeEl && (placeEl.value = entry?.place || '');
      tagEl && (tagEl.value = entry?.tag || '');
      notesEl && (notesEl.value = entry?.notes || '');
      latEl && (latEl.value = (typeof entry?.lat==='number')? String(entry.lat):'');
      lngEl && (lngEl.value = (typeof entry?.lng==='number')? String(entry.lng):'');
      tempMedia = (entry?.media||[]).map(m=>({ ...m })); // å·²æœ‰åª’ä½“åªæœ‰ url
      renderGallery(tempMedia);
      $('#delBtn') && ($('#delBtn').style.display = entry? 'inline-flex':'none');
      openDialog(entryDialog);
      setTimeout(()=>{ pickMap?.invalidateSize?.(); }, 80);
    }

    function renderGallery(items){
      if(!gallery) return; gallery.innerHTML='';
      for(const m of items){
        const wrap=document.createElement('div'); wrap.className='media';
        const src = m.url || m.preview;
        wrap.setAttribute('data-id', m.id);
        wrap.innerHTML=`${m.type==='image'
            ? `<img src="${src}" alt="media">`
            : `<video src="${src}" muted playsinline></video>`}
          <span class="badge">${m.type==='image'?'å›¾ç‰‡':'è§†é¢‘'}</span>
          <div style="position:absolute;left:.4rem;top:.4rem;display:flex;gap:.3rem">
            <button class="btn" data-view="${m.id}" type="button">é¢„è§ˆ</button>
            <button class="btn danger" data-remove="${m.id}" type="button">ç§»é™¤</button>
          </div>`;
        // é‡Šæ”¾é¢„è§ˆ URLï¼Œé¿å… iOS å†…å­˜æ³„æ¼
        const node = wrap.querySelector('img,video');
        if (m.preview && node) {
          node.addEventListener('load', ()=> URL.revokeObjectURL(m.preview), {once:true});
          node.addEventListener('loadeddata', ()=> URL.revokeObjectURL(m.preview), {once:true});
        }
        gallery.appendChild(wrap);
      }
    }

    $('#pickBtn')?.addEventListener('click', ()=> $('#filePick')?.click());
    $('#filePick')?.addEventListener('change', async (e)=>{
      const files=[...e.target.files||[]];
      for(const f of files){
        const isVideo=f.type.startsWith('video/'); const isImage=f.type.startsWith('image/');
        if(!isVideo && !isImage) continue;
        const preview = URL.createObjectURL(f);
        tempMedia.push({ id:uid(), type:isVideo?'video':'image', name:f.name, file:f, preview });
      }
      renderGallery(tempMedia);
      e.target.value='';
    });

    gallery?.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('button'); if(!btn) return;
      const id=btn.getAttribute('data-view')||btn.getAttribute('data-remove');
      const idx=tempMedia.findIndex(x=>x.id===id);
      if(btn.hasAttribute('data-remove')){ if(idx>-1){ tempMedia.splice(idx,1); renderGallery(tempMedia); } }
      if(btn.hasAttribute('data-view')){ openViewer(tempMedia[idx]); }
    });

    $('#clearMedia')?.addEventListener('click', ()=>{ if(confirm('æ¸…ç©ºè¿™æ¡è®°å½•çš„æ‰€æœ‰åª’ä½“ï¼Ÿ')) { tempMedia = []; renderGallery(tempMedia); } });

    // ä¿å­˜ï¼ˆä¸Šä¼ åª’ä½“ â†’ å†™å…¥ Firestoreï¼‰
    $('#saveBtn')?.addEventListener('click', async ()=>{
      const latNum = parseFloat(latEl?.value||'');
      const lngNum = parseFloat(lngEl?.value||'');
      const entryId = editingId || crypto.randomUUID();
      const base = {
        title: (titleEl?.value||'').trim()||'æœªå‘½åæ—…ç¨‹',
        date: dateEl?.value||'',
        place: (placeEl?.value||'').trim(),
        tag:(tagEl?.value||'').trim(),
        notes: notesEl?.value||'',
      };
      if(!Number.isNaN(latNum) && !Number.isNaN(lngNum)){ base.lat=latNum; base.lng=lngNum; }

      // å¤„ç†åª’ä½“ï¼ˆå›¾ç‰‡å‹ç¼©ï¼›è§†é¢‘ç›´ä¼ ï¼‰
      const processed = [];
      for(const m of tempMedia){
        if(m.file){
          if(m.type==='image'){
            const { blob, width, height } = await compressImage(m.file, 1920, .85);
            const u = await uploadMedia(roomId, entryId, blob, m.name);
            processed.push({ id:m.id, type:'image', name:m.name, url:u.url, width, height, bytes:u.bytes });
          }else{
            const u = await uploadMedia(roomId, entryId, m.file, m.name);
            processed.push({ id:m.id, type:'video', name:m.name, url:u.url, bytes:u.bytes });
          }
        }else if(m.url){
          processed.push(m);
        }
      }

      const docRef = doc(collection(db, "rooms", roomId, "entries"), entryId);
      await setDoc(docRef, { ...base, media: processed, updatedAt: serverTimestamp() }, { merge:true });
      closeDialog(entryDialog);
    });

    $('#delBtn')?.addEventListener('click', async ()=>{
      if(!editingId) return;
      if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')){
        await deleteDoc(doc(db, "rooms", roomId, "entries", editingId));
        closeDialog(entryDialog);
      }
    });

    // å¯¼å‡º/å¯¼å…¥ï¼ˆå¤‡ä»½/è¿ç§»ï¼‰
    $('#exportBtn')?.addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(entries, null, 2)], {type:'application/json;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`trip_journal_${roomId}.json`; a.click(); URL.revokeObjectURL(a.href); menu?.removeAttribute('open');
    });

    $('#importBtn')?.addEventListener('click', ()=>{
      const i=document.createElement('input'); i.type='file'; i.accept='application/json';
      i.onchange=async ()=>{
        const f=i.files && i.files[0]; if(!f) return;
        const text=await f.text();
        try{
          const data=JSON.parse(text);
          if(!Array.isArray(data)) throw new Error('bad format');
          if(!confirm('å¯¼å…¥ä¼šæŠŠ JSON ä¸­çš„è®°å½•å†™å…¥å½“å‰æˆ¿é—´ï¼ˆåª’ä½“çš„ dataURL å°†è¢«é‡æ–°ä¸Šä¼ ï¼‰ã€‚ç»§ç»­ï¼Ÿ')) return;
          for(const e of data){
            const eid = e.id || crypto.randomUUID();
            const media = [];
            for(const m of e.media||[]){
              if(m.dataUrl?.startsWith('data:')){
                const blob = await (await fetch(m.dataUrl)).blob();
                const up = await uploadMedia(roomId, eid, blob, m.name||'media');
                media.push({ id:m.id||crypto.randomUUID(), type:m.type, name:m.name, url:up.url, bytes:up.bytes });
              } else if (m.url) {
                media.push(m);
              }
            }
            await setDoc(doc(collection(db,"rooms",roomId,"entries"), eid),
              { title:e.title||'', date:e.date||'', place:e.place||'', tag:e.tag||'', notes:e.notes||'', lat:e.lat||null, lng:e.lng||null, media, updatedAt:serverTimestamp() },
              { merge:true });
          }
          alert('å¯¼å…¥å®Œæˆ');
        }catch{ alert('å¯¼å…¥å¤±è´¥ï¼šæ ¼å¼ä¸æ­£ç¡®'); }
      };
      i.click(); menu?.removeAttribute('open');
    });

    // é¢„è§ˆå™¨
    const viewer=$('#viewer'), viewerBody=$('#viewerBody');
    function openViewer(m){
      if(!viewer||!viewerBody) return;
      const src = m.url || m.preview;
      viewerBody.innerHTML = m.type==='image'
        ? `<img src="${src}" style="max-width:100%">`
        : `<video src="${src}" controls playsinline style="max-width:100%"></video>`;
      openDialog(viewer);
    }
    $('#viewerClose')?.addEventListener('click',()=> closeDialog(viewer));

    // åœ°å›¾ï¼ˆLeaflet + OSMï¼‰
    function initMap(){
      if(map) return;
      map = L.map('map', { zoomControl:true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap è´¡çŒ®è€…'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      map.setView([1.3521,103.8198], 4);
      setTimeout(()=> map.invalidateSize(), 100);
    }
    function markerPopupHtml(e){
      const m=e.media?.[0]; const src = m? (m.url||m.preview):null;
      const mediaHtml = src? (m.type==='image'
        ? `<img src="${src}" style="width:160px;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--outline)">`
        : `<video src="${src}" style="width:160px;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--outline)" muted playsinline></video>`) : '';
      return `<div style="min-width:180px">
        <div style="font-weight:700;margin-bottom:.25rem">${escapeHtml(e.title||'æœªå‘½å')}</div>
        ${e.date? `<div class="help" style="margin-bottom:.25rem">ğŸ“… ${e.date}</div>`:''}
        ${e.place? `<div class="help" style="margin-bottom:.25rem">ğŸ“ ${escapeHtml(e.place)}</div>`:''}
        ${mediaHtml}
      </div>`;
    }
    function refreshMapMarkers(){
      if(!map) return;
      markersLayer.clearLayers();
      const bounds=[];
      for(const e of entries){
        if(typeof e.lat==='number' && typeof e.lng==='number'){
          const m=L.marker([e.lat, e.lng]).bindPopup(markerPopupHtml(e));
          markersLayer.addLayer(m); bounds.push([e.lat,e.lng]);
        }
      }
      if(bounds.length){ map.fitBounds(bounds, {padding:[30,30]}); }
    }
    $('#mapFit')?.addEventListener('click', ()=>{ initMapOnce(); refreshMapMarkers(); });

    // åœ°å›¾æ‹¾å–åæ ‡
    const pickDialog=$('#pickDialog'); const pickInfo=$('#pickInfo');
    let pickMap, pickMarker; let tempPick = {lat:null, lng:null};
    function openPickMap(){
      openDialog(pickDialog);
      setTimeout(()=>{
        if(!pickMap){
          pickMap = L.map('pickMap');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(pickMap);
          pickMap.setView([1.3521,103.8198], 4);
          pickMap.on('click', (ev)=>{
            const {lat, lng} = ev.latlng;
            tempPick = {lat, lng};
            if(!pickMarker){ pickMarker = L.marker([lat,lng]).addTo(pickMap); }
            else { pickMarker.setLatLng([lat,lng]); }
            pickInfo.textContent = `å·²é€‰æ‹©ï¼š${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          });
        } else { pickMap.invalidateSize(); }
      }, 120);
    }
    $('#pickOnMapBtn')?.addEventListener('click', openPickMap);
    $('#pickCloseBtn')?.addEventListener('click', ()=> closeDialog(pickDialog));
    $('#pickUseBtn')?.addEventListener('click', ()=>{
      if(tempPick.lat!=null && tempPick.lng!=null){
        $('#lat').value = String(tempPick.lat);
        $('#lng').value = String(tempPick.lng);
        closeDialog(pickDialog);
      } else { alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä¸€ä¸ªä½ç½®'); }
    });

    // åœ¨çº¿åœ°ç†ç¼–ç ï¼ˆNominatimï¼‰
    const GEO_KEY='tj_geo_cache_v1';
    let geoCache = {};
    try{ geoCache = JSON.parse(localStorage.getItem(GEO_KEY)||'{}'); }catch{ geoCache = {} }
    async function geocodePlace(place){
      const key = place.trim().toLowerCase(); if(!key) return null;
      if(geoCache[key]) return geoCache[key];
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(place)}`;
      const res = await fetch(url, { headers: { 'Accept-Language':'zh-CN,zh;q=0.9,en;q=0.8' } });
      if(!res.ok) throw new Error('ç½‘ç»œé”™è¯¯');
      const arr = await res.json();
      if(arr && arr[0]){
        const p = { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon) };
        geoCache[key]=p; try{ localStorage.setItem(GEO_KEY, JSON.stringify(geoCache)); }catch{}
        return p;
      }
      return null;
    }
    $('#geocodeBtn')?.addEventListener('click', async ()=>{
      const name = ($('#place')?.value||'').trim(); if(!name){ alert('è¯·å…ˆå¡«å†™åœ°ç‚¹åç§°'); return; }
      const btn = $('#geocodeBtn'); const old = btn.textContent; btn.disabled=true; btn.textContent='å®šä½ä¸­â€¦';
      try{
        const p = await geocodePlace(name);
        if(p){ $('#lat').value = String(p.lat); $('#lng').value = String(p.lng); alert('å·²å†™å…¥åæ ‡'); }
        else { alert('æ²¡æœ‰æ‰¾åˆ°è¯¥åœ°ç‚¹çš„åæ ‡ï¼Œè¯·å°è¯•æ¢ä¸ªå†™æ³•æˆ–æ‰‹åŠ¨æ‹¾å–'); }
      }catch(e){ alert('ç½‘ç»œæˆ–æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•'); }
      finally{ btn.disabled=false; btn.textContent=old; }
    });

    // å·¥å…·
    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
    async function fileToDataURL(file){
      return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }
    async function compressImage(file, maxW=1920, quality=.85){
      const img = new Image(); img.src = URL.createObjectURL(file); await img.decode();
      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      const blob = await new Promise(res=> canvas.toBlob(res,'image/jpeg',quality));
      URL.revokeObjectURL(img.src);
      return { blob, width:w, height:h };
    }
    async function uploadMedia(roomId, entryId, fileOrBlob, filename){
      const mediaId = Math.random().toString(36).slice(2);
      const path = `rooms/${roomId}/${entryId}/${mediaId}-${(filename||'media').replace(/\s+/g,'_')}`;
      const r = ref(storage, path);
      const data = fileOrBlob;
      const snap = await uploadBytes(r, data);
      const url = await getDownloadURL(snap.ref);
      return { mediaId, url, bytes: data.size || 0 };
    }

    // dialog æ‰“å¼€/å…³é—­ï¼ˆå…¼å®¹åŸç”Ÿ/ polyfillï¼‰
    function openDialog(dlg){ if (!dlg) return; if (dlg.showModal) dlg.showModal(); else dlg.showModal?.(); }
    function closeDialog(dlg){ if (!dlg) return; if (dlg.close) dlg.close(); else dlg.close?.(); }

    // åˆå§‹åŒ–
    const y = document.getElementById('year'); if(y) y.textContent = new Date().getFullYear();
    function initMapOnce(){ if(!map){ initMap(); } else { setTimeout(()=> map.invalidateSize(), 100); } }
    initMapOnce();
  </script>
</body>
</html>
