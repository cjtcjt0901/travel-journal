<!doctype html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ä¸å¥¹çš„æ—…ç¨‹ Â· æ—…è¡Œè®°å¿†æœ¬ï¼ˆiPhone ç…§ç‰‡åº“å·²é€‚é…ï¼‰</title>
<meta name="description" content="å•æ–‡ä»¶æ—…è¡Œè®°å¿†æœ¬ï¼šæ–‡å­—/åœ°ç‚¹/æ—¥æœŸ/ç…§ç‰‡/è§†é¢‘ï¼›åœ¨çº¿åœ°å›¾ï¼ˆLeafletï¼‰ï¼›Firebase å®æ—¶åŒæ­¥ï¼›æœç´¢ï¼‹åˆ†é¡µï¼›iPhone Safari é€‚é…ã€‚"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>

<style>
:root{
  --bg:#0b0d12; --card:#121722; --text:#e6ebf4; --muted:#a9b4c8;
  --brand:#3b82f6; --accent:#22d3ee; --ring:rgba(59,130,246,.35);
  --line:rgba(255,255,255,.12); --line2:rgba(255,255,255,.2);
  --safe-top:env(safe-area-inset-top,0); --safe-bottom:env(safe-area-inset-bottom,0);
}
[data-theme="light"]{
  --bg:#f6f8fc; --card:#ffffff; --text:#111827; --muted:#5b677d;
  --brand:#2563eb; --accent:#06b6d4; --ring:rgba(37,99,235,.25);
  --line:rgba(0,0,0,.08); --line2:rgba(0,0,0,.12);
}

html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
  padding-bottom:var(--safe-bottom);
}
a{color:inherit;text-decoration:none}
.container{width:min(1100px,92vw);margin:0 auto}

header{
  position:sticky;top:0;z-index:10;
  -webkit-backdrop-filter:saturate(160%) blur(10px);
  backdrop-filter:saturate(160%) blur(10px);
  background:rgba(17,23,34,.55);
  border-bottom:1px solid var(--line);
  padding-top:calc(var(--safe-top)*1);
}
[data-theme="light"] header{background:rgba(255,255,255,.7)}
.nav{display:flex;align-items:center;justify-content:space-between;padding:.55rem 0}
.brand{font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:.6rem}
.pill{display:inline-block;font-size:.78rem;color:var(--brand);background:rgba(59,130,246,.12);padding:.15rem .55rem;border-radius:999px;border:1px solid rgba(59,130,246,.25)}

.btn{
  display:inline-flex;align-items:center;gap:.5rem;cursor:pointer;
  padding:.55rem .9rem;border-radius:12px;border:1px solid var(--line2);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  color:var(--text);font-size:.95rem;-webkit-tap-highlight-color:transparent;
}
.btn.primary{background:linear-gradient(180deg,var(--brand),#1d4ed8);color:#fff;border:0}
.btn.danger{border-color:#ef4444;color:#ef4444}
.btn:focus-visible{outline:3px solid var(--ring);outline-offset:2px}

input,textarea,select{
  width:100%;padding:.75rem;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);
  -webkit-appearance:none;appearance:none;
}
label{font-size:.9rem;color:var(--muted)}
.help{color:var(--muted);font-size:.88rem}

.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:1rem;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.card h3{margin:.2rem 0 .6rem}

.section{padding:1.2rem 0 2rem}
.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:1.4rem;align-items:start;padding:1rem 0 .5rem}
@media (max-width:980px){.hero{grid-template-columns:1fr}}

.row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media (max-width:640px){.row{grid-template-columns:1fr}}

.list{display:grid;gap:1rem}
.entry{display:grid;grid-template-columns:120px 1fr;gap:1rem;align-items:center}
.thumb{width:120px;height:80px;object-fit:cover;border-radius:12px;border:1px solid var(--line2);background:#00000022}
.thumb-btn{padding:0;border:0;background:transparent;cursor:pointer;border-radius:12px}
.thumb-btn:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
.meta{display:flex;gap:.6rem;flex-wrap:wrap;color:var(--muted);font-size:.9rem}

.gallery{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem}
@media (max-width:980px){.gallery{grid-template-columns:repeat(3,1fr)}}
@media (max-width:640px){.gallery{grid-template-columns:repeat(2,1fr)}}
.media{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
.media img,.media video{width:100%;height:100%;object-fit:cover;display:block}
.badge{position:absolute;right:.4rem;top:.4rem;background:rgba(0,0,0,.45);color:#fff;padding:.1rem .4rem;border-radius:8px;font-size:.75rem}

dialog{border:1px solid var(--line);border-radius:18px;padding:0;background:var(--card);color:var(--text);width:min(980px,94vw)}
dialog::backdrop{background:rgba(0,0,0,.5)}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--line)}
.modal-body{padding:1rem;max-height:min(72vh,820px);overflow:auto;-webkit-overflow-scrolling:touch}

.dlg-open{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
.dlg-panel{background:var(--card);border:1px solid var(--line);border-radius:18px;width:min(980px,94vw);max-height:min(72vh,820px);display:flex;flex-direction:column}
.dlg-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9998}

#map{height:420px;border-radius:16px;border:1px solid var(--line);overflow:hidden}
.leaflet-container{font:inherit;touch-action: pan-x pan-y;}
.map-tools{display:flex;gap:.5rem;flex-wrap:wrap}
.pager{display:flex;gap:.5rem;align-items:center;justify-content:center;margin-top:1rem}
.pager .info{min-width:7ch;text-align:center;color:var(--muted);font-size:.9rem}

/* å¤šä¸»é¢˜ */
[data-theme="sakura"]{ --bg:#1a1325; --card:#20172d; --text:#fdeaf6; --muted:#d9c0d8; --brand:#ec4899; --accent:#fb7185; --ring:rgba(236,72,153,.30); }
[data-theme="ocean"] { --bg:#08121a; --card:#0f1b27; --text:#e6f6ff; --muted:#a0c3d7; --brand:#06b6d4; --accent:#22d3ee; --ring:rgba(6,182,212,.30); }
[data-theme="forest"]{ --bg:#0b130f; --card:#111c16; --text:#e9faef; --muted:#b2d3bc; --brand:#22c55e; --accent:#16a34a; --ring:rgba(34,197,94,.30); }
[data-theme="warm"]  { --bg:#18110b; --card:#1f1710; --text:#fff4e5; --muted:#e6d1bb; --brand:#f59e0b; --accent:#f97316; --ring:rgba(245,158,11,.30); }

#userBg{position:fixed;inset:0;background:var(--user-bg, none);background-size:cover;background-position:center;background-repeat:no-repeat;opacity:.22;pointer-events:none;z-index:-1}

/* èœå•æµ®å±‚ */
.menu{position:absolute;right:0;top:calc(100% + .4rem);min-width:280px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:.6rem;box-shadow:0 6px 30px rgba(0,0,0,.22)}
.menu .title{font-weight:700;margin:.4rem 0 .2rem}
.menu .group{display:flex;gap:.5rem;flex-wrap:wrap;margin:.3rem 0 .6rem}
</style>
</head>

<body>
<div id="userBg"></div>

<header>
  <div class="container nav">
    <div class="brand">
      <span id="siteTitle" contenteditable="false" title="å•å‡»å¯ç¼–è¾‘">æ—…è¡Œè®°å¿†æœ¬ Â· ä¸å¥¹çš„æ—…ç¨‹</span>
      <span class="pill">iPhone ç…§ç‰‡åº“ Â· åœ°å›¾ Â· å®æ—¶åŒæ­¥</span>
    </div>
    <div style="position:relative">
      <button class="btn" id="menuBtn" type="button" aria-expanded="false" aria-controls="menuPanel">èœå• â–¾</button>
      <div id="menuPanel" class="menu" hidden>
        <div class="title">ä¸»é¢˜</div>
        <div class="group">
          <select id="themeSelect" style="flex:1">
            <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
            <option value="light">æµ…è‰²</option>
            <option value="dark">æ·±è‰²</option>
            <option value="sakura">æ¨±èŠ±</option>
            <option value="ocean">æµ·æ´‹</option>
            <option value="forest">æ£®æ—</option>
            <option value="warm">æš–é˜³</option>
          </select>
        </div>
        <div class="title">èƒŒæ™¯</div>
        <div class="group">
          <input id="bgPick" type="file" accept="image/*" style="display:none">
          <button class="btn" id="bgPickBtn" type="button">èƒŒæ™¯å›¾ç‰‡</button>
          <button class="btn danger" id="bgClearBtn" type="button">æ¸…é™¤èƒŒæ™¯</button>
        </div>
        <div class="title">æ•°æ®</div>
        <div class="group">
          <button class="btn" id="exportBtn" type="button">å¯¼å‡º JSON</button>
          <button class="btn" id="importBtn" type="button">å¯¼å…¥ JSON</button>
        </div>
        <div class="title">æˆ¿é—´</div>
        <div class="group" style="width:100%">
          <input id="roomInput" placeholder="roomIdï¼ˆç•™ç©º=our-journey-roomï¼‰" autocapitalize="off" autocomplete="off" autocorrect="off" style="flex:1">
          <button class="btn" id="roomApply" type="button">åˆ‡æ¢</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero">
    <div>
      <h1 id="heroTitle" contenteditable="false" title="å•å‡»å¯ç¼–è¾‘" style="margin:.2rem 0 0">æŠŠä½ ä»¬çš„æ¯ä¸€æ¬¡å‡ºå‘ï¼Œéƒ½ç•™åœ¨è¿™é‡Œ</h1>
      <p class="help">æ”¯æŒ <strong>æ ‡é¢˜/æ—¥æœŸ/åœ°ç‚¹/å¤‡æ³¨</strong>ï¼Œå¯æ·»åŠ å¤šå¼  <strong>ç…§ç‰‡</strong> ä¸ <strong>è§†é¢‘</strong>ï¼›å†…ç½® <strong>åœ¨çº¿åœ°å›¾</strong>ï¼›iPhone Safari é€‚é…ã€‚</p>
      <div class="row">
        <div class="card">
          <h3>æ—…è¡Œè¯­å½•</h3>
          <div id="quoteBox" style="font-size:1.05rem;line-height:1.7">å‡ºå‘ï¼Œæ‰ä¼šé‡è§é£æ™¯ã€‚<small>â€” ä¸å¥¹çš„æ—…ç¨‹</small></div>
          <div style="display:flex;gap:.6rem;margin-top:.8rem;flex-wrap:wrap">
            <button class="btn" id="quoteNext" type="button">æ¢ä¸€å¥</button>
            <button class="btn" id="quoteToggle" type="button" aria-pressed="false">è‡ªåŠ¨è½®æ¢ï¼šå…³</button>
          </div>
          <p class="help" style="margin-top:.6rem">å…³é—­é¡µé¢åè®¾ç½®ä¼šè‡ªåŠ¨è®°ä½ã€‚</p>
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <h2 style="margin:.2rem 0 .6rem">æ—…è¡Œåœ°å›¾</h2>
    <div class="map-tools" style="margin:.4rem 0 .6rem">
      <button class="btn" id="mapFit" type="button">è‡ªåŠ¨ç¼©æ”¾åˆ°å…¨éƒ¨è¶³è¿¹</button>
      <span class="help">ä¿å­˜/å¯¼å…¥è®°å½•åç‚¹å‡»â€œè‡ªåŠ¨ç¼©æ”¾â€æŸ¥çœ‹æ‰€æœ‰ Pinã€‚</span>
    </div>
    <div class="card">
      <div id="map" role="region" aria-label="æ—…è¡Œåœ°å›¾"></div>
    </div>
  </section>

  <section class="section">
    <h2 style="margin:.2rem 0 .8rem">æ—…ç¨‹åˆ—è¡¨</h2>
    <div style="display:flex;gap:.5rem;align-items:center;margin:.2rem 0 1rem">
      <input id="searchInput" placeholder="æœç´¢ï¼šæ ‡é¢˜ / åœ°ç‚¹ / æ ‡ç­¾ / å¤‡æ³¨ / 2025-11" autocomplete="off" autocapitalize="off" autocorrect="off">
      <button class="btn" id="searchClear" type="button">æ¸…é™¤</button>
      <button class="btn primary" id="newEntry" type="button">ï¼‹æ–°å»º</button>
    </div>
    <div id="empty" class="help" style="display:none">è¿˜æ²¡æœ‰è®°å½•ï¼Œç‚¹å‡»ä¸Šæ–¹ <strong>ï¼‹æ–°å»º</strong> è¯•è¯•å§ï½</div>
    <div id="noResult" class="help" style="display:none">æ²¡æœ‰åŒ¹é…çš„ç»“æœï¼Œè¯•è¯•æ›´çŸ­æˆ–ä¸åŒçš„å…³é”®è¯ã€‚</div>
    <div id="list" class="list"></div>
    <div id="pager" class="pager" style="display:none">
      <button class="btn" id="prevPage" type="button">ä¸Šä¸€é¡µ</button>
      <span class="info" id="pageInfo">1 / 1</span>
      <button class="btn" id="nextPage" type="button">ä¸‹ä¸€é¡µ</button>
    </div>
  </section>
</main>

<!-- ç¼–è¾‘å¯¹è¯æ¡† -->
<dialog id="entryDialog" aria-label="æ—…ç¨‹ç¼–è¾‘">
  <form method="dialog">
    <div class="modal-head">
      <strong id="dialogTitle">æ—…ç¨‹</strong>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button class="btn danger" id="delBtn" type="button">åˆ é™¤</button>
        <button class="btn" id="closeEntry" type="button">å…³é—­</button>
        <button class="btn primary" id="saveBtn" type="button">ä¿å­˜</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="row">
        <div>
          <label for="title">æ ‡é¢˜</label>
          <input id="title" placeholder="ä¾‹å¦‚ï¼š2025.11 å¯Œå£«å±±ä¸¤æ—¥è¡Œ" required autocomplete="off" autocapitalize="off" autocorrect="off">
        </div>
        <div>
          <label for="date">æ—¥æœŸ</label>
          <input id="date" type="date">
        </div>
      </div>
      <br>
      <div class="row">
        <div>
          <label for="place">åœ°ç‚¹ï¼ˆç”¨äºæœç´¢åæ ‡ï¼‰</label>
          <input id="place" placeholder="åŸå¸‚/æ™¯ç‚¹ï¼šæ²³å£æ¹–" autocomplete="off" autocapitalize="off" autocorrect="off">
        </div>
        <div>
          <label for="tag">æ ‡ç­¾</label>
          <input id="tag" placeholder="ä¾‹å¦‚ï¼šæ¨±èŠ±ã€æµ·å²›ã€èœœæœˆ" autocomplete="off">
        </div>
      </div>
      <br>
      <div class="row">
        <div>
          <label>åæ ‡ï¼ˆå¯æ‰‹åŠ¨æˆ–ä»åœ°å›¾æ‹¾å–ï¼‰</label>
          <div class="row" style="grid-template-columns:1fr 1fr">
            <input id="lat" placeholder="çº¬åº¦ï¼š35.3606" inputmode="decimal" autocapitalize="off" autocorrect="off">
            <input id="lng" placeholder="ç»åº¦ï¼š138.7274" inputmode="decimal" autocapitalize="off" autocorrect="off">
          </div>
          <div style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn" id="geocodeBtn" type="button">æ ¹æ®åœ°ç‚¹è‡ªåŠ¨å®šä½</button>
            <button class="btn" id="pickOnMapBtn" type="button">åœ¨åœ°å›¾ä¸Šæ‹¾å–åæ ‡</button>
          </div>
          <p class="help">å¤‡æ³¨ï¼šæœ‰åæ ‡ä¼˜å…ˆï¼›è‹¥æ— åæ ‡åˆ™ç”¨åœ°ç‚¹åç§°åœ¨çº¿æœç´¢ã€‚</p>
        </div>
        <div>
          <label for="notes">æ–‡å­—è®°å½•</label>
          <textarea id="notes" rows="6" placeholder="å†™ä¸‹è¿™è¶Ÿæ—…è¡Œçš„å°æ•…äº‹å§ï½"></textarea>
        </div>
      </div>
      <br>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
          <div>
            <strong>ç…§ç‰‡ / è§†é¢‘</strong>
            <p class="help">ä¸€æ¬¡å¯å¤šé€‰ï¼›æ”¯æŒ <code>.jpg .png .webp .gif .mp4 .webm</code>ã€‚</p>
          </div>
          <div style="display:flex;gap:.5rem">
            <!-- âœ… å…³é”®ï¼šæ—  captureï¼ŒiPhone ä¼šå¼¹å‡ºâ€œç…§ç‰‡å›¾åº“/æ‹æ‘„/æµè§ˆæ–‡ä»¶â€ -->
            <input id="filePick" type="file" accept="image/*,video/*" multiple style="display:none">
            <button class="btn" id="pickBtn" type="button">æ·»åŠ æ–‡ä»¶</button>
            <button class="btn danger" id="clearMedia" type="button">æ¸…ç©ºåª’ä½“</button>
          </div>
        </div>
        <div id="gallery" class="gallery" style="margin-top:.8rem"></div>
      </div>
    </div>
  </form>
</dialog>

<!-- åœ°å›¾åæ ‡æ‹¾å– -->
<dialog id="pickDialog" aria-label="é€‰æ‹©åæ ‡">
  <div class="modal-head">
    <span>åœ¨åœ°å›¾ä¸Šé€‰æ‹©åæ ‡</span>
    <div style="display:flex;gap:.5rem">
      <button class="btn" id="pickUseBtn" type="button">ä½¿ç”¨è¯¥åæ ‡</button>
      <button class="btn" id="pickCloseBtn" type="button">å…³é—­</button>
    </div>
  </div>
  <div class="modal-body">
    <div id="pickMap" style="height:420px;border-radius:16px;border:1px solid var(--line)"></div>
    <p class="help" id="pickInfo" style="margin-top:.5rem">ç‚¹å‡»åœ°å›¾è½ç‚¹ï¼›å¯ç¼©æ”¾ã€æ‹–åŠ¨ã€‚</p>
  </div>
</dialog>

<!-- é¢„è§ˆ -->
<dialog id="viewer" aria-label="é¢„è§ˆ">
  <div class="modal-head">
    <span>é¢„è§ˆ</span>
    <button class="btn" id="viewerClose" type="button">å…³é—­</button>
  </div>
  <div class="modal-body" id="viewerBody"></div>
</dialog>

<footer class="container" style="padding:2rem 0;border-top:1px solid var(--line);text-align:center">
  <small>Â© <span id="year"></span> ä¸å¥¹çš„æ—…ç¨‹ Â· å•æ–‡ä»¶æ—…è¡Œè®°å¿†æœ¬</small>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<!-- å…¼å®¹æ€§ï¼šè½»é‡ dialog polyfillï¼ˆæ—§ iOS/Safariï¼‰ -->
<script>
(function(){
  if (typeof HTMLDialogElement === 'function' && HTMLDialogElement.prototype.showModal) return;
  function polyfillDialog(dlg){
    if(!dlg || dlg.__polyfilled) return; dlg.__polyfilled = true;
    dlg.showModal = function(){
      if(this.open) return;
      this.open = true;
      this._backdrop = document.createElement('div'); this._backdrop.className='dlg-backdrop';
      document.body.appendChild(this._backdrop);
      const panel = document.createElement('div'); panel.className='dlg-panel';
      while (this.firstChild) panel.appendChild(this.firstChild);
      this._panel = panel;
      const host = document.createElement('div'); host.className='dlg-open'; host.appendChild(panel);
      this._host = host; document.body.appendChild(host);
    };
    dlg.close = function(){
      if(!this.open) return; this.open=false;
      if(this._host){ document.body.removeChild(this._host); this._host=null; }
      if(this._backdrop){ document.body.removeChild(this._backdrop); this._backdrop=null; }
    };
  }
  document.querySelectorAll('dialog').forEach(polyfillDialog);
})();
</script>

<!-- ä¸»é€»è¾‘ï¼ˆæ¨¡å—åŒ–ï¼‰ -->
<script type="module">
/* -------------------- å®‰å…¨å·¥å…· & UI åŸºç¡€ -------------------- */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function openDialog(dlg){ if(!dlg) return; if(dlg.showModal) dlg.showModal(); else dlg.open=true; }
function closeDialog(dlg){ if(!dlg) return; if(dlg.close) dlg.close(); else dlg.open=false; }
const logErr = (e, ctx='') => console.error(`[ERROR] ${ctx}`, e);

/* -------------------- ä¸»é¢˜ & èƒŒæ™¯ -------------------- */
const prefersDark = matchMedia('(prefers-color-scheme: dark)');
const themeSelect = $('#themeSelect'); const userBgEl = $('#userBg');
function applyTheme(mode){
  const doc = document.documentElement;
  if(mode==='auto') doc.setAttribute('data-theme', prefersDark.matches? 'dark':'light');
  else doc.setAttribute('data-theme', mode);
  try{ localStorage.setItem('tj_theme', mode); }catch{}
}
const savedMode = localStorage.getItem('tj_theme') || 'auto';
if(themeSelect) themeSelect.value = savedMode;
applyTheme(savedMode);
prefersDark.addEventListener('change', ()=>{ if((localStorage.getItem('tj_theme')||'auto')==='auto') applyTheme('auto'); });

$('#menuBtn')?.addEventListener('click', ()=>{
  const p = $('#menuPanel'); if(!p) return;
  const show = p.hasAttribute('hidden'); p.toggleAttribute('hidden', !show? true:false);
  $('#menuBtn').setAttribute('aria-expanded', show? 'true':'false');
});
document.addEventListener('click', (e)=>{
  const p = $('#menuPanel'); const btn = $('#menuBtn'); if(!p||!btn) return;
  if(!p.contains(e.target) && !btn.contains(e.target)) { p.setAttribute('hidden',''); btn.setAttribute('aria-expanded','false'); }
});
themeSelect?.addEventListener('change', (e)=>{ applyTheme(e.target.value); setTimeout(()=>{ map?.invalidateSize?.(); }, 80); });

$('#bgPickBtn')?.addEventListener('click', ()=> $('#bgPick')?.click());
$('#bgPick')?.addEventListener('change', async (e)=>{
  try{
    const f = e.target.files?.[0]; if(!f) return;
    const url = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    userBgEl?.style.setProperty('--user-bg', `url("${url}")`);
    localStorage.setItem('tj_user_bg', url); e.target.value='';
  }catch(err){ logErr(err,'set background'); }
});
$('#bgClearBtn')?.addEventListener('click', ()=>{
  try{ localStorage.removeItem('tj_user_bg'); userBgEl?.style.setProperty('--user-bg','none'); }catch{}
});
try{ const savedBg = localStorage.getItem('tj_user_bg'); if(savedBg) userBgEl?.style.setProperty('--user-bg', `url("${savedBg}")`); }catch{}

/* -------------------- æ ‡é¢˜å¯ç¼–è¾‘ -------------------- */
const TITLE_MAIN_KEY='tj_title_main', TITLE_HERO_KEY='tj_title_hero';
const siteTitleEl = $('#siteTitle'), heroTitleEl = $('#heroTitle');
try{
  const t1 = localStorage.getItem(TITLE_MAIN_KEY);
  const t2 = localStorage.getItem(TITLE_HERO_KEY);
  if(t1) siteTitleEl.textContent = t1;
  if(t2) heroTitleEl.textContent = t2;
  if(t1) document.title = t1 + 'ï¼ˆå®æ—¶åŒæ­¥ç‰ˆï¼‰';
}catch{}
function enableEdit(el){ if(!el) return; el.setAttribute('contenteditable','true'); el.focus(); }
function finalizeEdit(el, key){
  if(!el) return; const v=(el.textContent||'').replace(/[\u0000-\u001F\u007F]/g,'').trim();
  el.textContent = v || el.getAttribute('data-default') || el.textContent;
  try{ localStorage.setItem(key, el.textContent); }catch{}
  if(el===siteTitleEl) document.title = (el.textContent||'æ—…è¡Œè®°å¿†æœ¬ Â· ä¸å¥¹çš„æ—…ç¨‹') + 'ï¼ˆå®æ—¶åŒæ­¥ç‰ˆï¼‰';
  el.setAttribute('contenteditable','false');
}
siteTitleEl?.addEventListener('click', ()=> enableEdit(siteTitleEl));
heroTitleEl?.addEventListener('click', ()=> enableEdit(heroTitleEl));
siteTitleEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); siteTitleEl.blur(); }});
heroTitleEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); heroTitleEl.blur(); }});
siteTitleEl?.addEventListener('blur', ()=> finalizeEdit(siteTitleEl, TITLE_MAIN_KEY));
heroTitleEl?.addEventListener('blur', ()=> finalizeEdit(heroTitleEl, TITLE_HERO_KEY));

/* -------------------- æ—…è¡Œè¯­å½• -------------------- */
const QUOTE_KEY='tj_quote_auto';
const quotes = [
  ['æ—…è¡Œçš„æ„ä¹‰ï¼Œæ˜¯å’Œå–œæ¬¢çš„äººä¸€èµ·æŠŠä¸–ç•Œå˜å°ã€‚','â€” ä¸å¥¹çš„æ—…ç¨‹'],
  ['è¦ä¹ˆè¯»ä¹¦ï¼Œè¦ä¹ˆæ—…è¡Œï¼Œçµé­‚å’Œèº«ä½“ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªåœ¨è·¯ä¸Šã€‚','â€” ä½šå'],
  ['å‡ºå‘å¹¶ä¸ä¼Ÿå¤§ï¼Œèƒ½ä¸€èµ·å‡ºå‘æ‰æµªæ¼«ã€‚','â€” ä¸å¥¹çš„æ—…ç¨‹'],
  ['å’Œä½ åœ¨ä¸€èµ·ï¼Œå“ªé‡Œéƒ½æ˜¯è¿œæ–¹ã€‚','â€” ä¸å¥¹çš„æ—…ç¨‹'],
  ['ä¸–ç•Œå¾ˆå¤§ï¼Œåˆšå¥½æˆ‘ä»¬ä¸€èµ·ã€‚','â€” ä¸å¥¹çš„æ—…ç¨‹'],
  ['æœ€å¥½çš„æ—¶å…‰ï¼Œæ˜¯åœ¨è·¯ä¸Šï¼Œä¹Ÿæ˜¯åœ¨äººç¾¤ä¸­æ‰¾åˆ°ä½ ã€‚','â€” ä¸å¥¹çš„æ—…ç¨‹'],
  ['æŠŠå–œæ¬¢çš„ä¸€åˆ‡è£…è¿›è¡Œå›Šï¼šé˜³å…‰ã€æµ·é£ã€å’Œä½ çš„ç¬‘ã€‚','â€” ä¸å¥¹çš„æ—…ç¨‹'],
  ['å»çœ‹å±±æµ·ï¼Œä¹Ÿå»çœ‹ä½ çœ¼é‡Œçš„å…‰ã€‚','â€” ä¸å¥¹çš„æ—…ç¨‹']
];
const quoteBox = $('#quoteBox'), quoteNext = $('#quoteNext'), quoteToggle = $('#quoteToggle');
let quoteTimer=null, quoteAuto = (localStorage.getItem(QUOTE_KEY)||'0')==='1';
function pickQuote(){
  const [txt, from] = quotes[Math.floor(Math.random()*quotes.length)];
  if(quoteBox) quoteBox.innerHTML = `${escapeHtml(txt)}<small>${escapeHtml(from)}</small>`;
}
function applyQuoteAuto(on){
  quoteAuto = !!on; if(quoteToggle) quoteToggle.textContent = `è‡ªåŠ¨è½®æ¢ï¼š${on?'å¼€':'å…³'}`;
  try{ localStorage.setItem(QUOTE_KEY, on?'1':'0'); }catch{}
  if(quoteTimer){ clearInterval(quoteTimer); quoteTimer=null; }
  if(on) quoteTimer = setInterval(pickQuote, 6000);
}
quoteNext?.addEventListener('click', pickQuote);
quoteToggle?.addEventListener('click', ()=> applyQuoteAuto(!quoteAuto));
pickQuote(); applyQuoteAuto(quoteAuto);

/* -------------------- Leaflet åœ°å›¾ -------------------- */
let map, markersLayer;
function initMap(){
  if(map) return; map = L.map('map',{zoomControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap è´¡çŒ®è€…'}).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  map.setView([1.3521,103.8198], 4);
  setTimeout(()=> map.invalidateSize(), 100);
}
function markerPopupHtml(e){
  const m=e.media?.[0]; const src = m? (m.url||m.preview):null;
  const mediaHtml = src? (m.type==='image'
    ? `<img src="${src}" style="width:160px;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--line)"`
    : `<video src="${src}" style="width:160px;height:110px;object-fit:cover;border-radius:8px;border:1px solid var(--line)" muted playsinline></video>`) : '';
  return `<div style="min-width:180px">
    <div style="font-weight:700;margin-bottom:.25rem">${escapeHtml(e.title||'æœªå‘½å')}</div>
    ${e.date? `<div class="help" style="margin-bottom:.25rem">ğŸ“… ${e.date}</div>`:''}
    ${e.place? `<div class="help" style="margin-bottom:.25rem">ğŸ“ ${escapeHtml(e.place)}</div>`:''}
    ${mediaHtml}
  </div>`;
}
function refreshMapMarkers(){
  if(!map||!markersLayer) return;
  markersLayer.clearLayers(); const bounds=[];
  for(const e of entries){
    if(typeof e.lat==='number' && typeof e.lng==='number'){
      const m=L.marker([e.lat,e.lng]).bindPopup(markerPopupHtml(e));
      markersLayer.addLayer(m); bounds.push([e.lat,e.lng]);
    }
  }
  if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});
}
$('#mapFit')?.addEventListener('click', ()=>{ initMap(); refreshMapMarkers(); });
initMap();

/* -------------------- Firebase -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot,
  query, orderBy, serverTimestamp, enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

if (!('randomUUID' in crypto)) {
  crypto.randomUUID = ()=>'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)});
}

// âœ… ä½¿ç”¨æ ‡å‡† appspot åŸŸåï¼Œé¿å…ä¸Šä¼ å¤±è´¥
const firebaseConfig = {
  apiKey: "AIzaSyDuYmrNWhU5vXWpoEVk4IKamkuIjbH6AIo",
  authDomain: "travel-c2459.firebaseapp.com",
  projectId: "travel-c2459",
  storageBucket: "travel-c2459.firebasestorage.app",
  messagingSenderId: "142843430252",
  appId: "1:142843430252:web:089ef1595fc4db65cc9f49",
  measurementId: "G-EK5CCWX8QN"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// IndexedDB æŒä¹…åŒ–ï¼ˆå¤±è´¥åˆ™é™çº§ï¼‰
try{ await enableIndexedDbPersistence(db); }catch(e){ console.warn('IndexedDB ä¸å¯ç”¨ï¼Œå·²é™çº§ã€‚'); }

// æˆ¿é—´åˆ‡æ¢
const urlParams = new URLSearchParams(location.search);
let roomId = urlParams.get("room") || "our-journey-room";
const roomInput = $('#roomInput'); if(roomInput) roomInput.value = roomId;
$('#roomApply')?.addEventListener('click', ()=>{
  const r = (roomInput?.value||"").trim() || "our-journey-room";
  const u = new URL(location.href); u.searchParams.set('room', r); location.href = u.toString();
});

/* -------------------- æ•°æ® & åˆ—è¡¨ -------------------- */
let entries = [];      // å½“å‰æˆ¿é—´è®°å½•
let tempMedia = [];    // ç¼–è¾‘ä¸´æ—¶åª’ä½“
let searchTerm=''; let page=1, pageSize=10;

const list=$('#list'), empty=$('#empty'), noResult=$('#noResult');
const pager=$('#pager'), prevPage=$('#prevPage'), nextPage=$('#nextPage'), pageInfo=$('#pageInfo');
const searchInput=$('#searchInput');

function getEntryTime(e){
  if(e?.date){ const t=Date.parse(e.date); if(!Number.isNaN(t)) return t; }
  const u=e?.updatedAt;
  if(u && typeof u.toMillis==='function') return u.toMillis();
  if(typeof u==='number') return u;
  return 0;
}
function sortEntriesByDateDesc(arr){ return (arr||[]).slice().sort((a,b)=> getEntryTime(b)-getEntryTime(a)); }
function getFilteredEntries(){
  const term=(searchTerm||'').trim().toLowerCase();
  if(!term) return entries;
  return entries.filter(e=>{
    const hay=[e.title||'',e.place||'',e.tag||'',e.notes||'',e.date||''].join(' ').toLowerCase();
    return hay.includes(term);
  });
}
function firstMediaSrc(e){ const m=e.media?.[0]; return m? (m.url||m.preview):null; }

function renderList(){
  if(!list||!empty||!noResult) return;
  list.innerHTML='';
  const data = getFilteredEntries();
  const hasAny = entries.length>0;
  empty.style.display = hasAny? 'none':'block';
  noResult.style.display = (hasAny && data.length===0 && searchTerm)? 'block':'none';
  if(!data.length){ pager.style.display='none'; return; }

  const total=data.length, totalPages=Math.max(1,Math.ceil(total/pageSize));
  page=Math.min(Math.max(1,page),totalPages);
  const start=(page-1)*pageSize; const slice=data.slice(start,start+pageSize);

  for(const e of slice){
    const card=document.createElement('div'); card.className='card entry';
    const src=firstMediaSrc(e);
    const thumbInner = src
      ? (e.media[0].type==='image'
          ? `<img class="thumb" src="${src}" alt="thumb">`
          : `<video class="thumb" src="${src}" muted playsinline></video>`)
      : '<div class="thumb" aria-hidden="true"></div>';
    const hasCoord = (typeof e.lat==='number' && typeof e.lng==='number');
    card.innerHTML=`
      <button class="thumb-btn" data-open="${e.id}" type="button" aria-label="æŸ¥çœ‹/ç¼–è¾‘">${thumbInner}</button>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
          <h3 style="margin:.2rem 0">${escapeHtml(e.title||'æœªå‘½å')}</h3>
          <div style="display:flex;gap:.4rem;flex-wrap:wrap">
            <button class="btn" data-open="${e.id}" type="button">æŸ¥çœ‹/ç¼–è¾‘</button>
            <button class="btn" data-center="${e.id}" ${hasCoord? '':'disabled'} type="button">åœ¨åœ°å›¾ä¸Šå®šä½</button>
            <button class="btn danger" data-del="${e.id}" type="button">åˆ é™¤</button>
          </div>
        </div>
        <div class="meta">
          ${e.date?`<span>ğŸ“… ${e.date}</span>`:''}
          ${e.place?`<span>ğŸ“ ${escapeHtml(e.place)}</span>`:''}
          ${e.tag?`<span>ğŸ·ï¸ ${escapeHtml(e.tag)}</span>`:''}
          <span>ğŸ–¼ï¸ ${e.media?.length||0} é¡¹</span>
          ${hasCoord? `<span>ğŸ“Œ ${e.lat?.toFixed?.(4)}, ${e.lng?.toFixed?.(4)}</span>`:''}
        </div>
        ${e.notes? `<p class="help" style="margin:.4rem 0 0">${escapeHtml(e.notes).slice(0,160)}${e.notes.length>160?'â€¦':''}</p>`:''}
      </div>`;
    list.appendChild(card);
  }
  pageInfo.textContent = `${page} / ${Math.max(1,totalPages)}`;
  prevPage.disabled=(page<=1); nextPage.disabled=(page>=totalPages);
  pager.style.display='flex';
}

/* æœç´¢ä¸åˆ†é¡µ */
searchInput?.addEventListener('input', (e)=>{ searchTerm=e.target.value||''; page=1; renderList(); });
$('#searchClear')?.addEventListener('click', ()=>{ searchTerm=''; if(searchInput) searchInput.value=''; page=1; renderList(); });
prevPage?.addEventListener('click', ()=>{ if(page>1){ page--; renderList(); }});
nextPage?.addEventListener('click', ()=>{ page++; renderList(); });

/* -------------------- ç¼–è¾‘å™¨ & åª’ä½“ -------------------- */
const entryDialog=$('#entryDialog'), dialogTitle=$('#dialogTitle');
const titleEl=$('#title'), dateEl=$('#date'), placeEl=$('#place'), tagEl=$('#tag'), notesEl=$('#notes');
const latEl=$('#lat'), lngEl=$('#lng'), gallery=$('#gallery');
let editingId=null;

$('#newEntry')?.addEventListener('click', ()=> openEditor());

function openEditor(entry){
  editingId = entry?.id || null;
  if(dialogTitle) dialogTitle.textContent = entry? 'ç¼–è¾‘è®°å½•':'æ–°å»ºè®°å½•';
  if(titleEl) titleEl.value = entry?.title||'';
  if(dateEl) dateEl.value = entry?.date||'';
  if(placeEl) placeEl.value = entry?.place||'';
  if(tagEl) tagEl.value = entry?.tag||'';
  if(notesEl) notesEl.value = entry?.notes||'';
  if(latEl) latEl.value = (typeof entry?.lat==='number')? String(entry.lat):'';
  if(lngEl) lngEl.value = (typeof entry?.lng==='number')? String(entry.lng):'';
  tempMedia = (entry?.media||[]).map(m=>({ ...m })); // å·²æœ‰åª’ä½“åªæœ‰ url
  renderGallery(tempMedia);
  const delBtn = $('#delBtn'); if(delBtn) delBtn.style.display = entry? 'inline-flex':'none';
  openDialog(entryDialog);
}
$('#closeEntry')?.addEventListener('click', ()=> closeDialog(entryDialog));

function renderGallery(items){
  if(!gallery) return; gallery.innerHTML='';
  for(const m of items){
    const wrap=document.createElement('div'); wrap.className='media'; wrap.setAttribute('data-id', m.id);
    const src=m.url||m.preview;
    wrap.innerHTML = `${m.type==='image'
      ? `<img src="${src}" alt="">`
      : `<video src="${src}" muted playsinline></video>`}
      <span class="badge">${m.type==='image'?'å›¾ç‰‡':'è§†é¢‘'}</span>
      <div style="position:absolute;left:.4rem;top:.4rem;display:flex;gap:.3rem">
        <button class="btn" data-view="${m.id}" type="button">é¢„è§ˆ</button>
        <button class="btn danger" data-remove="${m.id}" type="button">ç§»é™¤</button>
      </div>`;
    const node = wrap.querySelector('img,video');
    if (m.preview && node) {
      node.addEventListener('load', ()=> URL.revokeObjectURL(m.preview), {once:true});
      node.addEventListener('loadeddata', ()=> URL.revokeObjectURL(m.preview), {once:true});
    }
    gallery.appendChild(wrap);
  }
}

$('#pickBtn')?.addEventListener('click', ()=> $('#filePick')?.click());
$('#filePick')?.addEventListener('change', async (e)=>{
  try{
    const files=[...e.target.files||[]];
    for(const f of files){
      const isVideo=f.type.startsWith('video/'); const isImage=f.type.startsWith('image/');
      if(!isVideo && !isImage) continue;
      const preview = URL.createObjectURL(f);
      tempMedia.push({ id:uid(), type:isVideo?'video':'image', name:f.name, file:f, preview });
    }
    renderGallery(tempMedia);
    e.target.value='';
  }catch(err){ logErr(err,'filePick change'); }
});
gallery?.addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('button'); if(!btn) return;
  const id=btn.getAttribute('data-view')||btn.getAttribute('data-remove');
  const idx=tempMedia.findIndex(x=>x.id===id); if(idx<0) return;
  if(btn.hasAttribute('data-remove')){ tempMedia.splice(idx,1); renderGallery(tempMedia); }
  if(btn.hasAttribute('data-view')){ openViewer(tempMedia[idx]); }
});
$('#clearMedia')?.addEventListener('click', ()=>{ if(confirm('æ¸…ç©ºè¿™æ¡è®°å½•çš„æ‰€æœ‰åª’ä½“ï¼Ÿ')) { tempMedia = []; renderGallery(tempMedia); } });

/* ä¿å­˜/åˆ é™¤ */
$('#saveBtn')?.addEventListener('click', async ()=>{
  try{
    const latNum=parseFloat(latEl?.value||''); const lngNum=parseFloat(lngEl?.value||'');
    const entryId = editingId || crypto.randomUUID();
    const base = {
      title:(titleEl?.value||'').trim()||'æœªå‘½åæ—…ç¨‹',
      date: dateEl?.value||'',
      place:(placeEl?.value||'').trim(),
      tag:(tagEl?.value||'').trim(),
      notes:notesEl?.value||''
    };
    if(!Number.isNaN(latNum) && !Number.isNaN(lngNum)){ base.lat=latNum; base.lng=lngNum; }

    const processed=[];
    for(const m of tempMedia){
      if(m.file){
        if(m.type==='image'){
          const { blob, width, height } = await compressImage(m.file, 1920, .85);
          const u = await uploadMedia(roomId, entryId, blob, m.name);
          processed.push({ id:m.id, type:'image', name:m.name, url:u.url, width, height, bytes:u.bytes });
        }else{
          const u = await uploadMedia(roomId, entryId, m.file, m.name);
          processed.push({ id:m.id, type:'video', name:m.name, url:u.url, bytes:u.bytes });
        }
      }else if(m.url){
        processed.push(m);
      }
    }
    const docRef = doc(collection(db,"rooms",roomId,"entries"), entryId);
    await setDoc(docRef, { ...base, media: processed, updatedAt: serverTimestamp() }, { merge:true });
    closeDialog(entryDialog);
  }catch(err){ logErr(err,'save entry'); alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Firebase æƒé™ã€‚'); }
});

$('#delBtn')?.addEventListener('click', async ()=>{
  if(!editingId) return;
  if(!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
  try{ await deleteDoc(doc(db,"rooms",roomId,"entries",editingId)); closeDialog(entryDialog); }
  catch(err){ logErr(err,'delete entry'); alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚'); }
});

/* é¢„è§ˆå™¨ */
const viewer=$('#viewer'), viewerBody=$('#viewerBody');
function openViewer(m){
  if(!viewer||!viewerBody) return;
  const src=m.url||m.preview;
  viewerBody.innerHTML = m.type==='image'
    ? `<img src="${src}" style="max-width:100%">`
    : `<video src="${src}" controls playsinline style="max-width:100%"></video>`;
  openDialog(viewer);
}
$('#viewerClose')?.addEventListener('click',()=> closeDialog(viewer));

/* å¯¼å‡º/å¯¼å…¥ */
$('#exportBtn')?.addEventListener('click', ()=>{
  try{
    const blob=new Blob([JSON.stringify(entries, null, 2)],{type:'application/json;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`trip_journal_${roomId}.json`; a.click(); URL.revokeObjectURL(a.href);
    $('#menuPanel')?.setAttribute('hidden','');
  }catch(err){ logErr(err,'export'); }
});
$('#importBtn')?.addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='application/json';
  i.onchange=async ()=>{
    const f=i.files && i.files[0]; if(!f) return;
    try{
      const text=await f.text(); const data=JSON.parse(text);
      if(!Array.isArray(data)) throw new Error('æ ¼å¼é”™è¯¯');
      if(!confirm('å¯¼å…¥ä¼šæŠŠ JSON ä¸­çš„è®°å½•å†™å…¥å½“å‰æˆ¿é—´ï¼ˆåª’ä½“çš„ dataURL å°†è¢«é‡æ–°ä¸Šä¼ ï¼‰ã€‚ç»§ç»­ï¼Ÿ')) return;
      for(const e of data){
        const eid = e.id || crypto.randomUUID();
        const media=[];
        for(const m of e.media||[]){
          if(m.dataUrl?.startsWith?.('data:')){
            const blob = await (await fetch(m.dataUrl)).blob();
            const up = await uploadMedia(roomId, eid, blob, m.name||'media');
            media.push({ id:m.id||crypto.randomUUID(), type:m.type, name:m.name, url:up.url, bytes:up.bytes });
          }else if(m.url){ media.push(m); }
        }
        await setDoc(doc(collection(db,"rooms",roomId,"entries"), eid),
          { title:e.title||'', date:e.date||'', place:e.place||'', tag:e.tag||'', notes:e.notes||'', lat:e.lat??null, lng:e.lng??null, media, updatedAt:serverTimestamp() },
          { merge:true });
      }
      alert('å¯¼å…¥å®Œæˆ');
    }catch(err){ logErr(err,'import'); alert('å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼ä¸æ­£ç¡®æˆ–ç½‘ç»œå¼‚å¸¸'); }
  };
  i.click(); $('#menuPanel')?.setAttribute('hidden','');
});

/* åˆ—è¡¨äº¤äº’ï¼ˆæ‰“å¼€/åˆ é™¤/åœ°å›¾å®šä½ï¼‰ */
list?.addEventListener('click', async (ev)=>{
  const t = ev.target.closest?.('button'); if(!t) return;
  const openId = t.getAttribute('data-open');
  const delId = t.getAttribute('data-del');
  const centerId = t.getAttribute('data-center');
  if(openId){ const it=entries.find(x=>x.id===openId); openEditor(it); }
  if(delId){
    if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')){
      try{ await deleteDoc(doc(db,"rooms",roomId,"entries",delId)); }catch(err){ logErr(err,'delete in list'); }
    }
  }
  if(centerId){
    const it=entries.find(x=>x.id===centerId);
    if(it && typeof it.lat==='number' && typeof it.lng==='number'){
      initMap(); map?.setView([it.lat,it.lng], 10, {animate:true});
    }
  }
});

/* -------------------- å®æ—¶è®¢é˜… -------------------- */
let signedIn=false;
try{ await signInAnonymously(auth); signedIn=true; }
catch(err){ logErr(err,'auth'); alert('åŒ¿åç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase Auth æ˜¯å¦å¼€å¯ã€‚'); }

if(signedIn){
  const colRef = collection(db,"rooms",roomId,"entries");
  const qy = query(colRef, orderBy("updatedAt","desc"));
  onAuthStateChanged(auth, ()=>{
    onSnapshot(qy, (snap)=>{
      entries = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      entries = sortEntriesByDateDesc(entries);
      page=1; renderList(); refreshMapMarkers();
    }, (err)=> logErr(err,'onSnapshot'));
  });
}

/* -------------------- åœ°å›¾åæ ‡æ‹¾å– & åœ°ç†ç¼–ç  -------------------- */
const pickDialog=$('#pickDialog'); const pickInfo=$('#pickInfo');
let pickMap, pickMarker; let tempPick = {lat:null,lng:null};
function openPickMap(){
  openDialog(pickDialog);
  setTimeout(()=>{
    if(!pickMap){
      pickMap = L.map('pickMap');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(pickMap);
      pickMap.setView([1.3521,103.8198], 4);
      pickMap.on('click',(ev)=>{
        const {lat,lng}=ev.latlng; tempPick={lat,lng};
        if(!pickMarker){ pickMarker=L.marker([lat,lng]).addTo(pickMap); }
        else pickMarker.setLatLng([lat,lng]);
        if(pickInfo) pickInfo.textContent=`å·²é€‰æ‹©ï¼š${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      });
    }else{ pickMap.invalidateSize(); }
  },120);
}
$('#pickOnMapBtn')?.addEventListener('click', openPickMap);
$('#pickCloseBtn')?.addEventListener('click', ()=> closeDialog(pickDialog));
$('#pickUseBtn')?.addEventListener('click', ()=>{
  if(tempPick.lat!=null && tempPick.lng!=null){
    if($('#lat')) $('#lat').value=String(tempPick.lat);
    if($('#lng')) $('#lng').value=String(tempPick.lng);
    closeDialog(pickDialog);
  }else alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä¸€ä¸ªä½ç½®');
});

// ç®€æ˜“ Nominatimï¼ˆå¸¦æœ¬åœ°ç¼“å­˜ï¼‰
const GEO_KEY='tj_geo_cache_v1';
let geoCache={}; try{ geoCache=JSON.parse(localStorage.getItem(GEO_KEY)||'{}'); }catch{ geoCache={}; }
async function geocodePlace(place){
  const key=place.trim().toLowerCase(); if(!key) return null;
  if(geoCache[key]) return geoCache[key];
  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(place)}`;
  const res=await fetch(url,{headers:{'Accept-Language':'zh-CN,zh;q=0.9,en;q=0.8','Referer':location.origin}});
  if(!res.ok) throw new Error('ç½‘ç»œé”™è¯¯');
  const arr=await res.json();
  if(arr && arr[0]){
    const p={ lat:parseFloat(arr[0].lat), lng:parseFloat(arr[0].lon) };
    geoCache[key]=p; try{ localStorage.setItem(GEO_KEY, JSON.stringify(geoCache)); }catch{}
    return p;
  }
  return null;
}
$('#geocodeBtn')?.addEventListener('click', async ()=>{
  const name=(placeEl?.value||'').trim(); if(!name){ alert('è¯·å…ˆå¡«å†™åœ°ç‚¹åç§°'); return; }
  const btn=$('#geocodeBtn'); const old=btn.textContent; btn.disabled=true; btn.textContent='å®šä½ä¸­â€¦';
  try{
    const p=await geocodePlace(name);
    if(p){ if(latEl) latEl.value=String(p.lat); if(lngEl) lngEl.value=String(p.lng); alert('å·²å†™å…¥åæ ‡'); }
    else alert('æ²¡æœ‰æ‰¾åˆ°è¯¥åœ°ç‚¹åæ ‡ï¼Œè¯·å°è¯•æ”¹å†™æˆ–æ‰‹åŠ¨æ‹¾å–');
  }catch(err){ logErr(err,'geocode'); alert('ç½‘ç»œæˆ–æœåŠ¡æš‚æ—¶ä¸å¯ç”¨'); }
  finally{ btn.disabled=false; btn.textContent=old; }
});

/* -------------------- å›¾ç‰‡å‹ç¼© & ä¸Šä¼  -------------------- */
async function compressImage(file, maxW=1920, quality=.85){
  const img=new Image(); img.src=URL.createObjectURL(file); await img.decode();
  const scale=Math.min(1,maxW/img.width); const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const blob=await new Promise(res=> cvs.toBlob(res,'image/jpeg',quality));
  URL.revokeObjectURL(img.src);
  return { blob, width:w, height:h };
}
async function uploadMedia(roomId, entryId, fileOrBlob, filename){
  const mediaId = Math.random().toString(36).slice(2);
  const path=`rooms/${roomId}/${entryId}/${mediaId}-${(filename||'media').replace(/\s+/g,'_')}`;
  const r=ref(storage,path); const data=fileOrBlob;
  const snap=await uploadBytes(r,data); const url=await getDownloadURL(snap.ref);
  return { mediaId, url, bytes:data.size||0 };
}

/* -------------------- å…¶ä»–åˆå§‹åŒ– -------------------- */
const y=$('#year'); if(y) y.textContent = new Date().getFullYear();
</script>
</body>
</html>

